{"meta":{"version":1,"warehouse":"4.0.0"},"models":{"Asset":[{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"themes/butterfly/source/css/index.styl","path":"css/index.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/css/var.styl","path":"css/var.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/404.jpg","path":"img/404.jpg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/algolia.svg","path":"img/algolia.svg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/favicon.png","path":"img/favicon.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/friend_404.gif","path":"img/friend_404.gif","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/icp.png","path":"img/icp.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/loading.gif","path":"img/loading.gif","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/tw_cn.js","path":"js/tw_cn.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/algolia.js","path":"js/search/algolia.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/local-search.js","path":"js/search/local-search.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/CNAME","hash":"c2b485dad4a4fd9b237372c1c3140bf39dae5439","modified":1574515647070},{"_id":"source/README.md","hash":"17e22ff1f8de976ffa5d1f07c74802976efd3a4d","modified":1574515647070},{"_id":"source/_posts/kafka_metrics.md","hash":"8aef1a6f5a4db3a274a15c7e42e17f8854ed44c8","modified":1574515647070},{"_id":"public/README.html","hash":"63d0acabec2cc0b9141c8d255b8e940952d27354","modified":1607365783157},{"_id":"public/2019/11/23/kafka_metrics/index.html","hash":"645275c2d9db1d692a12a67d44c8e4489b9a8345","modified":1607365783157},{"_id":"public/archives/index.html","hash":"7dd8e1e38435fec724a109e0b4d6c135d192529f","modified":1607365783157},{"_id":"public/archives/2019/index.html","hash":"9bf51888a9fd52e7968c2ca1071e150dcc5fe7ae","modified":1607365783157},{"_id":"public/archives/2019/11/index.html","hash":"da796f19b37a5ebc2e4ab6d7e1389f1e179fd5d4","modified":1607365783157},{"_id":"public/categories/kafka/index.html","hash":"04457cea19d63464d3f7189a94ccbbadf2d3003b","modified":1607365783157},{"_id":"public/index.html","hash":"d6fa1dfe6e0a34551b6fdbca4aa3e3586d242a9b","modified":1607365783157},{"_id":"public/tags/大数据-kafka/index.html","hash":"db518d019baacd7275ca3f86382bf863ba371238","modified":1607365783157},{"_id":"public/CNAME","hash":"c2b485dad4a4fd9b237372c1c3140bf39dae5439","modified":1607364369500},{"_id":"themes/butterfly/LICENSE","hash":"1128f8f91104ba9ef98d37eea6523a888dcfa5de","modified":1607365614825},{"_id":"themes/butterfly/README.md","hash":"954c73c718541de29bb5afedc357f30af64931f6","modified":1607365614825},{"_id":"themes/butterfly/package.json","hash":"c7fbcd1885e9c2b8018c7e78f4cfe9a94d7eb693","modified":1607365614866},{"_id":"themes/butterfly/README_CN.md","hash":"d250cc9a13dafbc57754fc8519e7a6d24daa5647","modified":1607365614826},{"_id":"themes/butterfly/_config.yml","hash":"af0bfbabbc48229a2de4de71f42df3ab904d9d67","modified":1607365614827},{"_id":"themes/butterfly/.github/stale.yml","hash":"05a55a87fa7f122c59683e41c8b2e37e79f688f0","modified":1607365614824},{"_id":"themes/butterfly/languages/default.yml","hash":"b55f6245cbf45ed6e2e010a326c0c10ec72f8f41","modified":1607365614827},{"_id":"themes/butterfly/languages/en.yml","hash":"b55f6245cbf45ed6e2e010a326c0c10ec72f8f41","modified":1607365614828},{"_id":"themes/butterfly/languages/zh-CN.yml","hash":"fd9e74bcda9902ae82d2749f55ab39e14520fad1","modified":1607365614829},{"_id":"themes/butterfly/languages/zh-TW.yml","hash":"36dcf023f4aff5a30d40b2704d9a31a07305f8be","modified":1607365614829},{"_id":"themes/butterfly/layout/404.pug","hash":"cb7b4fb164621d1fd7c33184241bd24662c85299","modified":1607365614829},{"_id":"themes/butterfly/layout/archive.pug","hash":"bd62286afb64a51c97e800c5945620d51605d5fa","modified":1607365614830},{"_id":"themes/butterfly/layout/category.pug","hash":"d014234c26d2c07caaea6703f7b48cb69c51907d","modified":1607365614830},{"_id":"themes/butterfly/layout/index.pug","hash":"e1c3146834c16e6077406180858add0a8183875a","modified":1607365614865},{"_id":"themes/butterfly/layout/page.pug","hash":"d5063ec93d33bd8488c12007709b6aafd8b9cf5f","modified":1607365614865},{"_id":"themes/butterfly/layout/post.pug","hash":"5253f6b175e3457af09289fd58cf277d544d085f","modified":1607365614866},{"_id":"themes/butterfly/layout/tag.pug","hash":"0440f42569df2676273c026a92384fa7729bc4e9","modified":1607365614866},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE/bug_report.md","hash":"01879e11e7fd1b1c98fb44c2b63c056af3d10415","modified":1607365614823},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE/custom.md","hash":"eff495eb1584cf4586e33c76e8b2fa6a469a179b","modified":1607365614824},{"_id":"themes/butterfly/layout/includes/additional-js.pug","hash":"e3a6dd5411273a06f702c5c0f0bf6af3760dff63","modified":1607365614830},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE/feature_request.md","hash":"f6867a2f0417fe89a0f2008730ee19dd38422021","modified":1607365614824},{"_id":"themes/butterfly/layout/includes/footer.pug","hash":"c38f7e0592e00144fc358885a5896d3b317ac4b6","modified":1607365614830},{"_id":"themes/butterfly/layout/includes/head.pug","hash":"85e9324745980e566ad7b389ab4e18e54f160867","modified":1607365614831},{"_id":"themes/butterfly/layout/includes/layout.pug","hash":"fb0617d91725433da023f342c094d8634fd5ffaa","modified":1607365614835},{"_id":"themes/butterfly/scripts/events/404.js","hash":"3c30dbd8b910ce7d8d7d8353cf2266cbc5d8775d","modified":1607365614867},{"_id":"themes/butterfly/layout/includes/pagination.pug","hash":"79ef449c5e04d0ecb4b9980d419ecbaf3d54d35a","modified":1607365614839},{"_id":"themes/butterfly/layout/includes/rightside.pug","hash":"0a7e1bc6cf4c93002100ed7460980f655ad53a04","modified":1607365614840},{"_id":"themes/butterfly/layout/includes/sidebar.pug","hash":"f81b25dfabfa50e76acd100b97774936179ad85f","modified":1607365614841},{"_id":"themes/butterfly/scripts/events/init.js","hash":"43b245c308797c2d62cb70429a85f1a05d3395ab","modified":1607365614868},{"_id":"themes/butterfly/scripts/events/welcome.js","hash":"d575137c8779e50422c2416f4d0832fdea346ee6","modified":1607365614868},{"_id":"themes/butterfly/scripts/filters/post_lazyload.js","hash":"e9cf275c362d8634f093e63068da7ed1e53c7600","modified":1607365614869},{"_id":"themes/butterfly/scripts/filters/random_cover.js","hash":"0f5017be123ae2b2ddf231d9d71a5c4cd1f2f206","modified":1607365614869},{"_id":"themes/butterfly/scripts/helpers/aside_archives.js","hash":"f30b0c108474b2869b35ee70dbc6ed2f2066979d","modified":1607365614872},{"_id":"themes/butterfly/scripts/helpers/aside_categories.js","hash":"ff79813afbaabd16188e7dbd435fe52273956c85","modified":1607365614873},{"_id":"themes/butterfly/scripts/helpers/page.js","hash":"51fb52f76423e4dbebd198f0a2a4190ed14e3093","modified":1607365614874},{"_id":"themes/butterfly/scripts/helpers/related_post.js","hash":"0d8ba6120dce617a2a1fbc9167572db2ee9f22ef","modified":1607365614875},{"_id":"themes/butterfly/scripts/tag/button.js","hash":"e75283267f3a4773e6d803593d557e218396f260","modified":1607365614875},{"_id":"themes/butterfly/scripts/tag/gallery.js","hash":"77e657eb74a7718b7e11e04284827e4a85805b86","modified":1607365614876},{"_id":"themes/butterfly/scripts/tag/hide.js","hash":"ea5939e3d5b3d3106527093a4fe0adaaf1fef2f8","modified":1607365614877},{"_id":"themes/butterfly/scripts/tag/mermaid.js","hash":"35f073021db93699fcac9ef351e26c59c31aadf7","modified":1607365614877},{"_id":"themes/butterfly/scripts/tag/note.js","hash":"c16c6eb058af2b36bcd583b2591076c7ebdd51ad","modified":1607365614878},{"_id":"themes/butterfly/scripts/tag/tabs.js","hash":"1f3bff5bbab30bb103e256ea6fb5b71a1bfe6dc1","modified":1607365614878},{"_id":"themes/butterfly/source/css/index.styl","hash":"d02ea8b8451513df5245151870195973709f25f2","modified":1607365614909},{"_id":"themes/butterfly/source/css/var.styl","hash":"e92eaefda462315051872b7894a6f6eb70a29006","modified":1607365614909},{"_id":"themes/butterfly/source/img/algolia.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1607365614912},{"_id":"themes/butterfly/source/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1607365614911},{"_id":"themes/butterfly/source/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1607365614912},{"_id":"themes/butterfly/source/img/icp.png","hash":"cb1fd69b38ec23ce8366668ddffbbd0160de0104","modified":1607365614915},{"_id":"themes/butterfly/source/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1607365614915},{"_id":"themes/butterfly/source/js/main.js","hash":"f72262242c4f0e4ae9027b5e291583dff7adc1b2","modified":1607365614917},{"_id":"themes/butterfly/source/img/loading.gif","hash":"5f0287fb8fb98872fe1998c6f781111819e71806","modified":1607365614916},{"_id":"themes/butterfly/source/js/tw_cn.js","hash":"2eafc44f4a5b24bef836b00dfc4360a84edb8dcc","modified":1607365614921},{"_id":"themes/butterfly/source/js/utils.js","hash":"f24426cd3c20057ecf46a872f748bece3fb9653a","modified":1607365614922},{"_id":"themes/butterfly/layout/includes/header/index.pug","hash":"abfa1d6a4f57273baedc6d1106d568d9c5c8014f","modified":1607365614833},{"_id":"themes/butterfly/layout/includes/header/menu_item.pug","hash":"14cd0f9c0c578512896b487263cd48570d74771a","modified":1607365614834},{"_id":"themes/butterfly/layout/includes/header/post-info.pug","hash":"f48fce85289971cb69d525b2cedeea3b0e5ac972","modified":1607365614834},{"_id":"themes/butterfly/layout/includes/header/nav.pug","hash":"da07d43d31dddc37cc1ac9766df86345bcefcdff","modified":1607365614834},{"_id":"themes/butterfly/layout/includes/header/social.pug","hash":"0d953e51d04a9294a64153c89c20f491a9ec42d4","modified":1607365614835},{"_id":"themes/butterfly/layout/includes/head/Open_Graph.pug","hash":"5390f2aea030486bf78678b910bda177b0ba5d05","modified":1607365614831},{"_id":"themes/butterfly/layout/includes/head/analytics.pug","hash":"afb58249ddd121e5a8cf5d289fe215e15b90b82a","modified":1607365614831},{"_id":"themes/butterfly/layout/includes/head/config_site.pug","hash":"630c1b07ec1c982dabdb44171eec5007c961d259","modified":1607365614832},{"_id":"themes/butterfly/layout/includes/head/config.pug","hash":"bd80f3fe3a25d29ba043f0f68bdfe681f88a10e3","modified":1607365614831},{"_id":"themes/butterfly/layout/includes/head/google_adsense.pug","hash":"95a37e92b39c44bcbea4be7e29ddb3921c5b8220","modified":1607365614832},{"_id":"themes/butterfly/layout/includes/head/js.pug","hash":"0b70ffee7dbc9b208669bc4a3849c01a1bbad4f5","modified":1607365614832},{"_id":"themes/butterfly/layout/includes/head/preconnect.pug","hash":"0fdf2a14f9ae498a6ca0de4409926001d4fb8b01","modified":1607365614833},{"_id":"themes/butterfly/layout/includes/head/pwa.pug","hash":"3d492cfe645d37c94d30512e0b230b0a09913148","modified":1607365614833},{"_id":"themes/butterfly/layout/includes/head/noscript.pug","hash":"d16ad2ee0ff5751fd7f8a5ce1b83935518674977","modified":1607365614832},{"_id":"themes/butterfly/layout/includes/head/site_verification.pug","hash":"62cf37e28795d8b68a0e850ec8c94987b9e08db5","modified":1607365614833},{"_id":"themes/butterfly/layout/includes/loading/loading.pug","hash":"5276937fbcceb9d62879dc47be880cd469a27349","modified":1607365614836},{"_id":"themes/butterfly/layout/includes/loading/loading-js.pug","hash":"7ffcf93bc5ee95ca461aea2735cedc0785c9884d","modified":1607365614835},{"_id":"themes/butterfly/layout/includes/mixins/article-sort.pug","hash":"68dfd3c6a0f00b3ffc0333c81e165b4626f7425f","modified":1607365614836},{"_id":"themes/butterfly/layout/includes/mixins/post-ui.pug","hash":"2a1201ad33033f6ff0748e37d0f31ed43eca0b9b","modified":1607365614836},{"_id":"themes/butterfly/layout/includes/page/default-page.pug","hash":"dbec869c62135695495703a29ad7655e9965d461","modified":1607365614838},{"_id":"themes/butterfly/layout/includes/page/categories.pug","hash":"1f30952fed73dec21b42e2e30b7fe2e84618d2e4","modified":1607365614838},{"_id":"themes/butterfly/layout/includes/page/artitalk.pug","hash":"46bc194907f481a3a5dec1bb36b30ccf953e1970","modified":1607365614837},{"_id":"themes/butterfly/layout/includes/post/post-copyright.pug","hash":"88e3b611b03149665e4113cfa39595c1a3fca7e5","modified":1607365614840},{"_id":"themes/butterfly/layout/includes/post/reward.pug","hash":"bab59f87da66386e5abc84550614752c660a0705","modified":1607365614840},{"_id":"themes/butterfly/layout/includes/page/flink.pug","hash":"da24e13ca15a376373fa3bae65f2bfb02f881b87","modified":1607365614838},{"_id":"themes/butterfly/layout/includes/third-party/aplayer.pug","hash":"b24959f00ac75f12f66b445158aad143ee860795","modified":1607365614841},{"_id":"themes/butterfly/layout/includes/page/tags.pug","hash":"93d4ebc7dc8228c7a10ddeb5a553d0dcdabbe145","modified":1607365614839},{"_id":"themes/butterfly/layout/includes/third-party/artitalk.pug","hash":"11f5227d3518bc91a85fdbd650a381aedfc10fe5","modified":1607365614841},{"_id":"themes/butterfly/layout/includes/third-party/baidu_push.pug","hash":"a3552fb4d969f72af0d1b099201faac1236e01d9","modified":1607365614842},{"_id":"themes/butterfly/layout/includes/third-party/pangu.pug","hash":"abce595b5b8887577af07a8e2644fd76d2443556","modified":1607365614853},{"_id":"themes/butterfly/layout/includes/third-party/effect.pug","hash":"29b851208aba27b62cae45b17d18c2237c278292","modified":1607365614847},{"_id":"themes/butterfly/layout/includes/third-party/pjax.pug","hash":"c81c2fef5f5606a1236cd24b6aa5bcf0e8a12594","modified":1607365614853},{"_id":"themes/butterfly/layout/includes/third-party/prismjs.pug","hash":"1fbecfd299068f90d727f0c8c65e2a792fa6e3e2","modified":1607365614854},{"_id":"themes/butterfly/layout/includes/third-party/subtitle.pug","hash":"2e7ff2078f20a6c00f2b9302e9c95e248f4b182b","modified":1607365614858},{"_id":"themes/butterfly/layout/includes/widget/card_ad.pug","hash":"2e940de1a6261fd378e16e4cd3362a9d69c12f50","modified":1607365614859},{"_id":"themes/butterfly/layout/includes/widget/card_announcement.pug","hash":"721b611fda6dcfca8f88b9c7b70fede7b69a516b","modified":1607365614860},{"_id":"themes/butterfly/layout/includes/widget/card_archives.pug","hash":"393a6f9a5dcabe8d96e9b6cb5620c12966dfd37f","modified":1607365614860},{"_id":"themes/butterfly/layout/includes/widget/card_author.pug","hash":"acad3c16a6bfb78384cb8d93347039ab9c4e13d4","modified":1607365614861},{"_id":"themes/butterfly/layout/includes/widget/card_categories.pug","hash":"83cb6ba0d8c913570147b3871c7fc0674dac8cdf","modified":1607365614861},{"_id":"themes/butterfly/layout/includes/widget/card_newest_comment.pug","hash":"7969da94b82531f2b7add111d209e6f80abf69a2","modified":1607365614862},{"_id":"themes/butterfly/layout/includes/widget/card_post_toc.pug","hash":"8931b62fb5d80deb2ea15928c6e94b0839f3dca4","modified":1607365614863},{"_id":"themes/butterfly/layout/includes/widget/card_recent_post.pug","hash":"e275297f48503a28792b5c8f9a92492183274f44","modified":1607365614863},{"_id":"themes/butterfly/layout/includes/widget/card_tags.pug","hash":"2b78fb1ed7fa91dc0957d025d2e4561522db4d7a","modified":1607365614863},{"_id":"themes/butterfly/layout/includes/widget/card_webinfo.pug","hash":"66261dbc6a3ff2c943c9ca829a59126f2d8182ec","modified":1607365614863},{"_id":"themes/butterfly/layout/includes/widget/index.pug","hash":"d1f451f3c52c1cc5c018dd0f9728d046494924da","modified":1607365614864},{"_id":"themes/butterfly/source/css/_global/function.styl","hash":"ba91e5b25b26596d194ac1eca7b44611f9539bcd","modified":1607365614880},{"_id":"themes/butterfly/source/css/_global/index.styl","hash":"73eee1d104edaf0ce62934dccd4915412aaaf199","modified":1607365614880},{"_id":"themes/butterfly/source/css/_highlight/highlight.styl","hash":"66ebb4c2f505c30d9e972d8bc5d863f6e2f40b9d","modified":1607365614881},{"_id":"themes/butterfly/source/css/_highlight/theme.styl","hash":"fa7a4c1685f391d60ed863e869b9604b59746c27","modified":1607365614887},{"_id":"themes/butterfly/source/css/_mode/darkmode.styl","hash":"cb4c275561c19691fcb4380fd4f84c1ec567f68e","modified":1607365614899},{"_id":"themes/butterfly/source/css/_mode/readmode.styl","hash":"d8b2ca51f3c702886fedf4da736ab968b90b8682","modified":1607365614899},{"_id":"themes/butterfly/source/css/_page/archives.styl","hash":"6874adc2e276443f354bbe50d0072e9bec37243c","modified":1607365614900},{"_id":"themes/butterfly/source/css/_page/categories.styl","hash":"e554549f0a0ae85362f0b0e8687981741f486f6b","modified":1607365614900},{"_id":"themes/butterfly/source/css/_page/common.styl","hash":"275091fc84f69f2b75b9dc4b0da1bc3c2c9d7a59","modified":1607365614901},{"_id":"themes/butterfly/source/css/_page/flink.styl","hash":"43f00986410f3dc0eed9e0bf9478801da32be24f","modified":1607365614901},{"_id":"themes/butterfly/source/css/_page/homepage.styl","hash":"6f2a1688bf873ab738f73a89e1be8f72e18b2a47","modified":1607365614901},{"_id":"themes/butterfly/source/css/_page/tags.styl","hash":"9a881c031f463c486bd25248c2814fd09f97892b","modified":1607365614902},{"_id":"themes/butterfly/source/css/_layout/404.styl","hash":"a510b67364d40794f9f0575c24b6987cab0b802a","modified":1607365614888},{"_id":"themes/butterfly/source/css/_layout/aside.styl","hash":"cedf558a69405895fd56b1b9e1e76642b61b441a","modified":1607365614889},{"_id":"themes/butterfly/source/css/_layout/chat.styl","hash":"29f48f9370f245e6e575b5836bccf47eb5688d8b","modified":1607365614890},{"_id":"themes/butterfly/source/css/_layout/comments.styl","hash":"f1b63892baafa48ab872bc79671d57aafd511f6c","modified":1607365614892},{"_id":"themes/butterfly/source/css/_layout/footer.styl","hash":"fd825c9d71fcd06a7c882850d1db0e9637f84107","modified":1607365614893},{"_id":"themes/butterfly/source/css/_layout/head.styl","hash":"3924f186002a22d326ce2991e2c46294b6e360fd","modified":1607365614893},{"_id":"themes/butterfly/source/css/_layout/loading.styl","hash":"7d18a7be9cfea65091de3ef00014063d2d649912","modified":1607365614894},{"_id":"themes/butterfly/source/css/_layout/pagination.styl","hash":"9e63cad808503d787b1485211333bef8e8a37571","modified":1607365614894},{"_id":"themes/butterfly/source/css/_layout/relatedposts.styl","hash":"76d67b9a42e8b0c3d17316a6d75c5b5b4c65fb68","modified":1607365614896},{"_id":"themes/butterfly/source/css/_layout/post.styl","hash":"29625b50968d0e8e04877eb35bbf424d35a0d591","modified":1607365614895},{"_id":"themes/butterfly/source/css/_layout/reward.styl","hash":"7bf7af4754baba07edfc614621bdb965442cdc2f","modified":1607365614897},{"_id":"themes/butterfly/source/css/_layout/rightside.styl","hash":"9803267893e979abd872158d571c2d947790bdc8","modified":1607365614897},{"_id":"themes/butterfly/source/css/_layout/sidebar.styl","hash":"7a6e1f21173022a3a1f18a62785cdd657a1af0a1","modified":1607365614898},{"_id":"themes/butterfly/source/css/_layout/third-party.styl","hash":"9a5f3ef155545814b349171d4c8203babbdfb57c","modified":1607365614898},{"_id":"themes/butterfly/source/css/_search/algolia.styl","hash":"6b05ca4409d2dc09e123af4e0af9f9d0f7142b73","modified":1607365614902},{"_id":"themes/butterfly/source/css/_search/index.styl","hash":"89e744abc5e41f4855e7b87b13b854f4ec4ffc0e","modified":1607365614903},{"_id":"themes/butterfly/source/css/_tags/button.styl","hash":"a7fc7624a8d893bdf9444f14154484c29c790e99","modified":1607365614905},{"_id":"themes/butterfly/source/css/_search/local-search.styl","hash":"560caad31c4efaede9b889710c922c9f9c20e6bf","modified":1607365614904},{"_id":"themes/butterfly/source/css/_tags/gallery.styl","hash":"6e74130e3cc5598d15a2f37fc558cc0086c11c66","modified":1607365614906},{"_id":"themes/butterfly/source/css/_tags/hexo.styl","hash":"d0386ba6d8d63afc72b9673e8f3e89df6446ffc2","modified":1607365614907},{"_id":"themes/butterfly/source/css/_tags/hide.styl","hash":"41a92e96c66dececcad050ada2201de196f5f697","modified":1607365614907},{"_id":"themes/butterfly/source/css/_tags/note.styl","hash":"86fee274a62f7f034547342930f445c47378eb55","modified":1607365614908},{"_id":"themes/butterfly/source/css/_tags/tabs.styl","hash":"1756791581c0ec51cb03353a09dac4778d944349","modified":1607365614908},{"_id":"themes/butterfly/source/css/_third-party/normalize.min.css","hash":"2c18a1c9604af475b4749def8f1959df88d8b276","modified":1607365614909},{"_id":"themes/butterfly/source/js/search/algolia.js","hash":"4bc8047817a3a0c11df8409399d57913d713a2a6","modified":1607365614917},{"_id":"themes/butterfly/source/js/search/local-search.js","hash":"92f2c4c651264331fa7d03e96e79bda4fd0f87db","modified":1607365614918},{"_id":"themes/butterfly/layout/includes/third-party/chat/chatra.pug","hash":"481cd5053bafb1a19f623554a27d3aa077ea59c3","modified":1607365614842},{"_id":"themes/butterfly/layout/includes/third-party/chat/crisp.pug","hash":"76634112c64023177260d1317ae39cef2a68e35f","modified":1607365614842},{"_id":"themes/butterfly/layout/includes/third-party/chat/daovoice.pug","hash":"cfe63e7d26a6665df6aa32ca90868ad48e05ec04","modified":1607365614842},{"_id":"themes/butterfly/layout/includes/third-party/chat/gitter.pug","hash":"d1d2474420bf4edc2e43ccdff6f92b8b082143df","modified":1607365614843},{"_id":"themes/butterfly/layout/includes/third-party/chat/index.pug","hash":"3f05f8311ae559d768ee3d0925e84ed767c314d3","modified":1607365614843},{"_id":"themes/butterfly/layout/includes/third-party/chat/tidio.pug","hash":"24a926756c2300b9c561aaab6bd3a71fdd16e16d","modified":1607365614843},{"_id":"themes/butterfly/layout/includes/third-party/math/index.pug","hash":"53af4ffa8119c7bbba3f066de74845be91400b5b","modified":1607365614848},{"_id":"themes/butterfly/layout/includes/third-party/math/katex.pug","hash":"73356f1068c7426597e268d6c4aefa2b0ac3a1d9","modified":1607365614848},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/disqus-comment.pug","hash":"9cad8dccda6a64938d1dedc85e860514d13c3b4d","modified":1607365614851},{"_id":"themes/butterfly/layout/includes/third-party/math/mermaid.pug","hash":"1310800bc30b4e1cad93982991041589ee70ffef","modified":1607365614851},{"_id":"themes/butterfly/layout/includes/third-party/math/mathjax.pug","hash":"4afc12ce42d067fa4012039aa444343a36f73599","modified":1607365614850},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/index.pug","hash":"e67a95ca1034023fd8151ca901eafced8ff50c87","modified":1607365614852},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/github-issues.pug","hash":"e529ef34ac60335b21d9fc2cdaa8b1e2b57e665c","modified":1607365614852},{"_id":"themes/butterfly/layout/includes/third-party/comments/disqus.pug","hash":"f617cacf5d1e8335abba96ee1ce4b79c17411e1e","modified":1607365614844},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/leancloud.pug","hash":"c002c905b338fc5ab567ceb0a42284a11638381e","modified":1607365614852},{"_id":"themes/butterfly/layout/includes/third-party/comments/disqusjs.pug","hash":"b217b84bfcaa2db48ca98d18a9bc3c459d0092fe","modified":1607365614844},{"_id":"themes/butterfly/layout/includes/third-party/comments/gitalk.pug","hash":"4e6bf11006e4260e85cc02dca330b6c76abd6016","modified":1607365614845},{"_id":"themes/butterfly/layout/includes/third-party/comments/facebook_comments.pug","hash":"b579b947a87da500a4f3abbdf870fb5a6f2a5a79","modified":1607365614844},{"_id":"themes/butterfly/layout/includes/third-party/comments/index.pug","hash":"0ae03966cf19f972d511d93fcb87bbdeb0e03fbf","modified":1607365614845},{"_id":"themes/butterfly/layout/includes/third-party/comments/js.pug","hash":"63d28a7655df2b3b2a70ab2b0c5c5e775a7662bf","modified":1607365614845},{"_id":"themes/butterfly/layout/includes/third-party/comments/livere.pug","hash":"52ea8aa26b84d3ad38ae28cdf0f163e9ca8dced7","modified":1607365614846},{"_id":"themes/butterfly/layout/includes/third-party/comments/utterances.pug","hash":"b871ea208e36398b4d668db9a9a0b61c79415381","modified":1607365614847},{"_id":"themes/butterfly/layout/includes/third-party/comments/twikoo.pug","hash":"e822f3abc1c1bfdda406d348b7558b79b94eb3ad","modified":1607365614846},{"_id":"themes/butterfly/layout/includes/third-party/comments/valine.pug","hash":"5b7e83a8bc66d877ea32b5779e8a5f650558f457","modified":1607365614847},{"_id":"themes/butterfly/layout/includes/third-party/search/algolia.pug","hash":"d8f59e94eafc669c49349561dc5bbea3915aecb7","modified":1607365614856},{"_id":"themes/butterfly/layout/includes/third-party/search/local-search.pug","hash":"87355ca445f16ace4316c63ca2fe8749c5abae06","modified":1607365614856},{"_id":"themes/butterfly/layout/includes/third-party/search/index.pug","hash":"da3b9437d061ee68dbc383057db5c73034c49605","modified":1607365614856},{"_id":"themes/butterfly/layout/includes/third-party/share/addtoany.pug","hash":"309f51bc5302e72fc469d54c577fbcfe57fb07a8","modified":1607365614857},{"_id":"themes/butterfly/layout/includes/third-party/share/add-this.pug","hash":"2980f1889226ca981aa23b8eb1853fde26dcf89a","modified":1607365614857},{"_id":"themes/butterfly/layout/includes/third-party/share/index.pug","hash":"c40f7d6973811e53fcfbe881174ab373b4ea03ad","modified":1607365614858},{"_id":"themes/butterfly/layout/includes/third-party/share/share-js.pug","hash":"368f5f75c506db77e4e1a20c29e9a3e2b4c3d783","modified":1607365614858},{"_id":"themes/butterfly/source/css/_highlight/highlight/diff.styl","hash":"3bcd66576d13db8f93fa5b799a973d55e060a708","modified":1607365614882},{"_id":"themes/butterfly/source/css/_highlight/highlight/index.styl","hash":"52c63a50a37fa315753e72b3661676156aeae794","modified":1607365614882},{"_id":"themes/butterfly/source/css/_highlight/prismjs/diff.styl","hash":"5972c61f5125068cbe0af279a0c93a54847fdc3b","modified":1607365614883},{"_id":"themes/butterfly/source/css/_highlight/prismjs/index.styl","hash":"897a18a82c0cad141b3ed9e2f1b4af60c24c334b","modified":1607365614885},{"_id":"themes/butterfly/source/css/_highlight/prismjs/line-number.styl","hash":"d40f1baec16c4a62e4a3a9a0379d1ca3ac6746b2","modified":1607365614886},{"_id":"public/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1607365684057},{"_id":"public/img/algolia.svg","hash":"ec119560b382b2624e00144ae01c137186e91621","modified":1607365684057},{"_id":"public/img/favicon.png","hash":"3cf89864b4f6c9b532522a4d260a2e887971c92d","modified":1607365684057},{"_id":"public/img/icp.png","hash":"cb1fd69b38ec23ce8366668ddffbbd0160de0104","modified":1607365684057},{"_id":"public/img/loading.gif","hash":"5f0287fb8fb98872fe1998c6f781111819e71806","modified":1607365684057},{"_id":"public/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1607365684057},{"_id":"public/css/var.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1607365684057},{"_id":"public/js/utils.js","hash":"f24426cd3c20057ecf46a872f748bece3fb9653a","modified":1607365684057},{"_id":"public/js/search/algolia.js","hash":"4bc8047817a3a0c11df8409399d57913d713a2a6","modified":1607365684057},{"_id":"public/js/search/local-search.js","hash":"92f2c4c651264331fa7d03e96e79bda4fd0f87db","modified":1607365684057},{"_id":"public/css/index.css","hash":"9cfcb4ea4e04ae8791b6948412b0a098d4046ec8","modified":1607365684057},{"_id":"public/js/main.js","hash":"f72262242c4f0e4ae9027b5e291583dff7adc1b2","modified":1607365684057},{"_id":"public/js/tw_cn.js","hash":"2eafc44f4a5b24bef836b00dfc4360a84edb8dcc","modified":1607365684057}],"Category":[{"name":"kafka","_id":"ckiev8tn30002lgjkcchedllg"}],"Data":[],"Page":[{"_content":"# woozhijun.github.io\n","source":"README.md","raw":"# woozhijun.github.io\n","date":"2019-11-23T13:27:27.070Z","updated":"2019-11-23T13:27:27.070Z","path":"README.html","title":"","comments":1,"layout":"page","_id":"ckiev8tmg0000lgjk4kmnf5k6","content":"<h1 id=\"woozhijun-github-io\"><a href=\"#woozhijun-github-io\" class=\"headerlink\" title=\"woozhijun.github.io\"></a>woozhijun.github.io</h1>","site":{"data":{}},"excerpt":"","more":"<h1 id=\"woozhijun-github-io\"><a href=\"#woozhijun-github-io\" class=\"headerlink\" title=\"woozhijun.github.io\"></a>woozhijun.github.io</h1>"}],"Post":[{"title":"洞悉 Kafka metrics","_content":"\n## 摘要\n> 本次主要介绍关键的Kafka性能指标，Kafka metrics不同收集方式及数据上报的实现，最后确保达到有效监控Kafka工作状态的目的.\n\n## Kafka metrics\nKafka使用Yammer Metrics来上报服务端和客户端的Metric信息，通过配置采集相应数据上报监控系统，展示可视化结果。\nYammer Metrics提供6种形式的Metrics收集 —— Gauges，Counters，Histograms，Timers，Health Checks，Metrics Annotation。\nYammer Metrics将Metrics收集与上报分离，可以根据需要自由组合。目前支持的Reporter有Console Reporter，JMX Reporter，CSV Reporter，SLF4J Reporter，HTTP Reporter，Ganglia Reporter，Graphite Reporter。\n因此，Kafka将可以通过以上组合输出我们想要的Metrics数据。\n\n### metrics收集\n#### 注册\n\n```\nfinal MetricRegistry metrics = new MetricRegistry();\n```\n\n#### Gauges\ngauge是一个数值的瞬时测量。比如我们可能需要衡量队列中待处理作业的数量：\n\n```\npublic class QueueManager {\n    private final Queue queue;\n    public QueueManager(MetricRegistry metrics, String name) {\n        this.queue = new Queue();\n        // name(QueueManager.class, name, \"size\") 中间按.分隔\n        metrics.register(MetricRegistry.name(QueueManager.class, name, \"size\"),\n                         new Gauge<Integer>() {\n                             @Override\n                             public Integer getValue() {\n                                 return queue.size();\n                             }\n                         });\n    }\n}\n```\n\n#### Counters\ncounter是AtomicLong类型的gauge，你可以增加或减少其值。比如我们可能需要更有效的统计阻塞在队列里job的数量：\n\n```\nprivate final Counter pendingJobs = metrics.counter(name(QueueManager.class, \"pending-jobs\"));\npublic void addJob(Job job) {\n    // 自增\n    pendingJobs.inc();\n    queue.offer(job);\n}\npublic Job takeJob() {\n    pendingJobs.dec();\n    return queue.take();\n}\n\nMetricRegistry.name(QueueManager.class, \"jobs\", \"size\")\n```\n\n#### Histograms\nhistogram统计数据的分布，比如min,max,mean,stddev,median,P75,P90,P95,P98,P99,P99.9等的值\n\n```\nprivate final Histogram responseSizes = metrics.histogram(name(RequestHandler.class, \"response-sizes\"));\n\npublic void handleRequest(Request request, Response response) {\n    // 增加上报的值\n    responseSizes.update(response.getContent().length);\n}\n```\n\n#### Timers\nTimer统计一个特定的代码片段被调用的速率和其持续时间的分布，比如统计response的耗时：\n\n```\nprivate final Timer responses = metrics.timer(name(RequestHandler.class, \"responses\"));\n\npublic String handleRequest(Request request, Response response) {\n    final Timer.Context context = responses.time();\n    try {\n        // 具体执行逻辑\n        return \"OK\";\n    } finally {\n        context.stop();\n    }\n}\n```\n\n#### Health Checks\n主要用户可以自己判断系统的健康状态，比如判断数据库是否连接正常：\n\n```\nfinal HealthCheckRegistry healthChecks = new HealthCheckRegistry();\n\npublic class DatabaseHealthCheck extends HealthCheck {\n    private final Database database;\n\n    public DatabaseHealthCheck(Database database) {\n        this.database = database;\n    }\n\n    @Override\n    public HealthCheck.Result check() throws Exception {\n        if (database.isConnected()) {\n            return HealthCheck.Result.healthy();\n        } else {\n            return HealthCheck.Result.unhealthy(\"Cannot connect to \" + database.getUrl());\n        }\n    }\n}\n\nhealthChecks.register(\"postgres\", new DatabaseHealthCheck(database));\n```\n\n#### Metrics Annotation\n注解方式，简单的实现统计某个方法、某个值的数据：\n\n```\n/**\n* 统计调用的次数和时间\n*/\n@Timed\npublic void call() {\n}\n    \n/**\n* 统计登陆的次数\n*/\n@Counted\npublic void userLogin(){\n}\n\n//other\n@CachedGauge @Gauge @ExceptionMetered @Metered @Metric\n``` \n\n### metrics上报\n#### ConsoleReporter\n对于简单指标的计算，可以使用定期向控制台报告：\n\n```\nfinal ConsoleReporter reporter = ConsoleReporter.forRegistry(metrics)\n\t\t\t\t                    .convertRatesTo(TimeUnit.SECONDS)\n\t\t\t\t                    .convertDurationsTo(TimeUnit.MILLISECONDS).build();\nmetrics.register(\"jvm.mem\", new MemoryUsageGaugeSet());\nmetrics.register(\"jvm.gc\", new GarbageCollectorMetricSet());\n                                                \nreporter.start(5, TimeUnit.MINUTES);\n```\n\n#### JmxReporter\n使用Jmx上报数据，转化为MBean，注：不建议在生产环境中使用，JMX的RPC API是不可靠的，但为了开发和浏览可选可视化工具：\n\n```\nfinal JmxReporter reporter = JmxReporter.forRegistry(registry).build();\nreporter.start();\n```\n\n#### CsvReporter\n对于相对复杂的指标，可将同一个metric创建.csv文件，并将定期上报的数据按新行写入：\n\n```\nfinal CsvReporter reporter = CsvReporter.forRegistry(registry)\n                                        .formatFor(Locale.US)\n                                        .convertRatesTo(TimeUnit.SECONDS)\n                                        .convertDurationsTo(TimeUnit.MILLISECONDS)\n                                        .build(new File(\"~/projects/data/\"));\nreporter.start(1, TimeUnit.SECONDS);\n```\n\n#### Slf4jReporter\n可以将上报数据记录slf4j日志：\n\n```\nfinal Slf4jReporter reporter = Slf4jReporter.forRegistry(registry)\n                                            .outputTo(LoggerFactory.getLogger(\"com.example.metrics\"))\n                                            .convertRatesTo(TimeUnit.SECONDS)\n                                            .convertDurationsTo(TimeUnit.MILLISECONDS)\n                                            .build();\nreporter.start(1, TimeUnit.MINUTES);\n```\n\n#### HTTP Reporter\n需搭建web服务，新增Listener事件，完成相应metrics指标注册，目前支持HealthCheckServlet，ThreadDumpServlet，MetricsServlet，PingServlet四类，最后启动服务即可请求获取Json格式的监控数据。实现详情如下：\n\n```\npublic class MyMetricsServletListener extends MetricsServlet.ContextListener {\n\t\n\tpublic static final MetricRegistry metrics = new MetricRegistry();\n\n\t@Override\n\tprotected MetricRegistry getMetricRegistry() {\n\t\t\n\t\tmetrics.register(\"jvm.mem\", new MemoryUsageGaugeSet());\n\t\tmetrics.register(\"jvm.gc\", new GarbageCollectorMetricSet());\n\t\tSystem.out.println(\">>.Listener success...\");\n\t\treturn metrics;\n\t}\n}\n```\n\n```\npublic class MyHealthCheckServletListener extends HealthCheckServlet.ContextListener {\n\n\tpublic static final HealthCheckRegistry healthCheck = new HealthCheckRegistry();\n\t@Override\n\tprotected HealthCheckRegistry getHealthCheckRegistry() {\n\t\t\n\t\thealthCheck.register(\"postgres\", new TFHealthCheck(false));\n\t\treturn healthCheck;\n\t}\n}\n```\n\n```\n\t<listener>\n        <listener-class>com.immomo.hubble.kafka.servlet.MyMetricsServletListener</listener-class>\n\t</listener>\n\t<listener>\n        <listener-class>com.immomo.hubble.kafka.servlet.MyHealthCheckServletListener</listener-class>\n\t</listener>\n\t\n\t<servlet>\n        <servlet-name>metrics</servlet-name>\n        <servlet-class>com.codahale.metrics.servlets.AdminServlet</servlet-class>\n\t</servlet>\n\t<servlet-mapping>\n\t   <servlet-name>metrics</servlet-name>\n\t   <url-pattern>/metrics/*</url-pattern>\n\t</servlet-mapping>\n```\n\n[源码地址](https://github.com/dropwizard/metrics)\n\n\n### Kafka性能指标\n#### kafka.server\nBrokerTopicMetrics,name=MessagesInPerSec: 每秒消息量\nBrokerTopicMetrics,name=BytesInPerSec: 每秒输入字节数\nBrokerTopicMetrics,name=BytesOutPerSec: 每秒输出字节数\nReplicaManager,name=UnderReplicatedPartitions: 复制分区的数量，默认0，|ISR|<|all replicas|\nReplicaManager,name=PartitionCount: 分区数\nReplicaManager,name=LeaderCount: Leader副本数\nReplicaManager,name=IsrShrinksPerSec: ISR回退\nReplicaManager,name=IsrExpandsPerSec: ISR超前 value is 0\nReplicaFetcherManager,name=MaxLag,clientId=Replica: 滞后follower和leader的最大消息长度\nFetcherLagMetrics,name=ConsumerLag,clientId=([-.\\w]+),topic=([-.\\w]+),partition=([0-9]+): 滞后follower的消息长度\nDelayedOperationPurgatory,name=PurgatorySize,delayedOperation=Produce: producer等待请求大小\nDelayedOperationPurgatory,name=PurgatorySize,delayedOperation=Fetch: 获取等待请求大小\nKafkaRequestHandlerPool,name=RequestHandlerAvgIdlePercent: 平均处理线程空闲时间\n\n#### kafka.network\nkafka.network:type=RequestMetrics,name=$1,request={Produce|FetchConsumer|FetchFollower}\nRequestsPerSec: 每秒请求量\nTotalTimeMs: 请求总时间\nRequestQueueTimeMs: 请求队列等待时间\nLocalTimeMs: 请求leader处理时间\nRemoteTimeMs: 请求follower等待时间\nResponseQueueTimeMs: 请求队列等待响应时间\nResponseSendTimeMs: 请求响应发送时间\nkafka.network:type=SocketServer,name=NetworkProcessorAvgIdlePercent: 平均网络处理空闲时间\n    \n#### kafka.controller\nKafkaController,name=ActiveControllerCount: 活跃broker数量\nControllerStats,name=LeaderElectionRateAndTimeMs: leader选举率\nControllerStats,name=UncleanLeaderElectionsPerSec: Unclean leader选举率\n\n#### common\nconnection-close-rate: 每秒连接关闭率\nconnection-creation-rate: 每秒新建连接率\nnetwork-io-rate: 平均每秒IO次数（读取或写入）\noutgoing-byte-rat: 平均每秒向服务器发送的字节数\nrequest-rate: 平均每秒发送的请求数\nincoming-byte-rate: 每秒读取字节数\nresponse-rate: 每秒收到的回复\nselect-rate: IO切换次数\nio-wait-ratio: IO线程等待时间\nconnection-count: 当前活跃连接数\n    \n#### broker\noutgoing-byte-rate: 平均每秒发送字节数\nrequest-rate: 平均每秒请求数\nrequest-size-avg: 所有请求的平均大小\nrequest-latency-avg: 平均请求时间(ms)\nresponse-rate: 每秒收到的响应数\n    \n#### producer\nwaiting-threads: 缓存区排队的用户阻塞线程数\nbuffer-available-bytes: 可用内存字节数\nbatch-size-avg: 每个分区每次请求发送的平均字节数\ncompression-rate-avg: 批量记录平均压缩率\nrecord-queue-time-avg: 批量记录耗费的平均时间（ms）\nrequest-latency-avg: 平均请求时间（ms）\nrecord-send-rate: 每秒发送的平均次数\nrecord-retry-rate: 每秒重试发送次数\nrecord-error-rate: 每秒错误数量次数\nrequests-in-flight: 目前等待响应的请求数量\nmetadata-age: 当前生产者数据使用周期（s）\n    \n#### consumer\n##### Consumer Group\ncommit-latency-avg: 提交请求所用的平均时间\ncommit-rate: 每秒提交调用次数\nassigned-partitions: 当前分配给该消费者的分区数（可选）\nheartbeat-rate: 平均每秒心跳数\njoin-time-avg: 群组重新加入的平均时间\njoin-rate: 每秒连接组的数量\nsync-time-avg: 群组同步所需的平均时间\nsync-rate: 每秒同步的组数\n    \n##### consumer fetch\nfetch-size-avg: 每次请求获取的平均字节数\nbytes-consumed-rate: 每秒消耗的平均字节数\nfetch-latency-avg: 请求所用的平均时间\nfetch-rate: 每秒提取请求数\nrecords-lag-max: 分区中记录的最大滞后数量\n    \n##### topic-level fetch\nfetch-size-avg: topic请求的平均字节数\nbytes-consumed-rate: topic每秒平均消耗的字节数\n\n#### streams\n##### Thread\n[commit|poll|process|punctuate]-latency-avg: 平均执行时间（ms）\n[commit|poll|process|punctuate]-rate: 平均每秒请求数\ntask-created-rate: 每秒新建任务数\ntask-closed-rate: 每秒关闭任务数\nskipped-records-rate: 每秒跳过记录数\n    \n##### Task\ncommit-latency-avg: 平均执行时间（ms）\ncommit-rate: 每秒提交的平均次数\n\n##### Processor Node\nforward-rate: 每秒从源节点向下游转发的平均速率\n\n##### State Store \n[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-latency-avg: 平均执行时间（ns）\n[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-rate: 每秒的平均运行速度\n\n#### others\nGC、CPU、IO等\n\n### Monitoring实现\n#### 方式一：\n1.提供Web服务支持，执行监听器注册我们需要监控的指标，可按Json格式输出\n2.启动后台进程定期通过Http请求抓取指标，并上报数据到redis队列\n3.storm消费数据进行分析计算\n\n```\n需多依赖\n<dependency>\n    <groupId>io.dropwizard.metrics</groupId>\n    <artifactId>metrics-servlets</artifactId>\n    <version>3.1.0</version>\n</dependency>\n```\n\n#### 方式二：\n1.重写KafkaReporter继承ScheduledReporter，构造相应指标，格式化、序列化Json，通过metrics收集统计结果\n2.创建kafkaProducer将构造的结果数据按不同Topic分类发送给kafka\n3.storm消费对应kafka数据，再进行分析计算\n\nPom依赖：\n\n```\n<dependency>\n    <groupId>org.apache.kafka</groupId>\n    <artifactId>kafka_2.11</artifactId>\n    <version>0.10.2.1</version>\n    <exclusions>\n        <exclusion>\n            <groupId>org.apache.zookeeper</groupId>\n            <artifactId>zookeeper</artifactId>\n\t\t\t</exclusion>\n    </exclusions>\n</dependency>\n<dependency>\n    <groupId>org.apache.zookeeper</groupId>\n    <artifactId>zookeeper</artifactId>\n    <version>3.4.10</version>\n    <exclusions>\n        <exclusion>\n            <groupId>com.sun.jmx</groupId>\n            <artifactId>jmxri</artifactId>\n        </exclusion>\n\t\t\t<exclusion>\n\t\t\t\t<groupId>com.sun.jdmk</groupId>\n\t\t\t\t<artifactId>jmxtools</artifactId>\n\t\t\t</exclusion>\n\t\t\t<exclusion>\n\t\t\t\t<groupId>javax.jms</groupId>\n\t\t\t\t<artifactId>jms</artifactId>\n\t\t\t</exclusion>\n\t\t</exclusions>\n\t</dependency>\n\t<dependency>\n\t       <groupId>io.dropwizard.metrics</groupId>\n\t       <artifactId>metrics-core</artifactId>\n\t       <version>3.1.0</version>\n\t</dependency>\n```\n\n### Kafka监控工具\n#### KafkaOffsetMonitor\n> 是由Kafka开源社区提供的一款Web管理界面，配置操作简单，界面简单，但不能自动刷新，但功能覆盖不全\n> 可以对consumer消费情况进行监控，并能列出每个consumer的offset数据\n> 可以查看每个topic的partition的列表（topic，pid，offset，logsize，lag，owner等）\n> 可以查看每个consumser group列表信息\n> 可以查看topic的历史消费信息\n> [源码地址](https://github.com/quantifind/KafkaOffsetMonitor)\n    \n#### kafka-web-console\n> 也是kafka开源的web监控程序，Scala编写，编译搭建相对于前者更复杂，默认用的数据库是H2，但可自动刷新。\n> 可以查看brokers kafka集群信息\n> 可以查看每个topic的Partition，logsize，分区leader等信息\n> 可以查看consumer group的partition，offset，lag，owner等信息；topic feed最新发布消息\n> 可以查看consumer偏移和滞后情况，历史消息以及consumer/producer消息吞吐量历史的图表\n> 控制台还提供了RAML中描述的JSON API\n> [源码地址](https://github.com/claudemamo/kafka-web-console)\n\n#### kafka-manger\n> 是由yahoo构建一款基于web的kafka管理器，可以管理多个kafka集群，且容易检测集群（topics,brokers,备份,分区）分布不均的情况\n> 可以选择你要运行的副本\n> 可以基于当前分区状况重新分配生成分区\n> 可以选择topic配置并创建topic(0.8.1.1和0.8.2+的配置不同)\n> 可以删除topic(只支持0.8.2+的版本并且要在broker配置中设置delete.topic.enable=true)，Topic list会指明哪些topic被删除\n> 可以为已存在的topic增加分区，更新配置\n> 可以支持多个topic批量重分区，选择partition broker位置等\n> 可以启用JMX轮询代理，以及broker、metrics主题等级\n> 可选地筛选出zookeeper中没有ids/owner/＆offset/目录的消费者\n> [源码地址](https://github.com/yahoo/kafka-manager)\n\n## QA\n**欢迎大家共同讨论、分享**\n\n\n\n","source":"_posts/kafka_metrics.md","raw":"---\ntitle: 洞悉 Kafka metrics\ntags: 大数据 kafka\ncategory: kafka\n---\n\n## 摘要\n> 本次主要介绍关键的Kafka性能指标，Kafka metrics不同收集方式及数据上报的实现，最后确保达到有效监控Kafka工作状态的目的.\n\n## Kafka metrics\nKafka使用Yammer Metrics来上报服务端和客户端的Metric信息，通过配置采集相应数据上报监控系统，展示可视化结果。\nYammer Metrics提供6种形式的Metrics收集 —— Gauges，Counters，Histograms，Timers，Health Checks，Metrics Annotation。\nYammer Metrics将Metrics收集与上报分离，可以根据需要自由组合。目前支持的Reporter有Console Reporter，JMX Reporter，CSV Reporter，SLF4J Reporter，HTTP Reporter，Ganglia Reporter，Graphite Reporter。\n因此，Kafka将可以通过以上组合输出我们想要的Metrics数据。\n\n### metrics收集\n#### 注册\n\n```\nfinal MetricRegistry metrics = new MetricRegistry();\n```\n\n#### Gauges\ngauge是一个数值的瞬时测量。比如我们可能需要衡量队列中待处理作业的数量：\n\n```\npublic class QueueManager {\n    private final Queue queue;\n    public QueueManager(MetricRegistry metrics, String name) {\n        this.queue = new Queue();\n        // name(QueueManager.class, name, \"size\") 中间按.分隔\n        metrics.register(MetricRegistry.name(QueueManager.class, name, \"size\"),\n                         new Gauge<Integer>() {\n                             @Override\n                             public Integer getValue() {\n                                 return queue.size();\n                             }\n                         });\n    }\n}\n```\n\n#### Counters\ncounter是AtomicLong类型的gauge，你可以增加或减少其值。比如我们可能需要更有效的统计阻塞在队列里job的数量：\n\n```\nprivate final Counter pendingJobs = metrics.counter(name(QueueManager.class, \"pending-jobs\"));\npublic void addJob(Job job) {\n    // 自增\n    pendingJobs.inc();\n    queue.offer(job);\n}\npublic Job takeJob() {\n    pendingJobs.dec();\n    return queue.take();\n}\n\nMetricRegistry.name(QueueManager.class, \"jobs\", \"size\")\n```\n\n#### Histograms\nhistogram统计数据的分布，比如min,max,mean,stddev,median,P75,P90,P95,P98,P99,P99.9等的值\n\n```\nprivate final Histogram responseSizes = metrics.histogram(name(RequestHandler.class, \"response-sizes\"));\n\npublic void handleRequest(Request request, Response response) {\n    // 增加上报的值\n    responseSizes.update(response.getContent().length);\n}\n```\n\n#### Timers\nTimer统计一个特定的代码片段被调用的速率和其持续时间的分布，比如统计response的耗时：\n\n```\nprivate final Timer responses = metrics.timer(name(RequestHandler.class, \"responses\"));\n\npublic String handleRequest(Request request, Response response) {\n    final Timer.Context context = responses.time();\n    try {\n        // 具体执行逻辑\n        return \"OK\";\n    } finally {\n        context.stop();\n    }\n}\n```\n\n#### Health Checks\n主要用户可以自己判断系统的健康状态，比如判断数据库是否连接正常：\n\n```\nfinal HealthCheckRegistry healthChecks = new HealthCheckRegistry();\n\npublic class DatabaseHealthCheck extends HealthCheck {\n    private final Database database;\n\n    public DatabaseHealthCheck(Database database) {\n        this.database = database;\n    }\n\n    @Override\n    public HealthCheck.Result check() throws Exception {\n        if (database.isConnected()) {\n            return HealthCheck.Result.healthy();\n        } else {\n            return HealthCheck.Result.unhealthy(\"Cannot connect to \" + database.getUrl());\n        }\n    }\n}\n\nhealthChecks.register(\"postgres\", new DatabaseHealthCheck(database));\n```\n\n#### Metrics Annotation\n注解方式，简单的实现统计某个方法、某个值的数据：\n\n```\n/**\n* 统计调用的次数和时间\n*/\n@Timed\npublic void call() {\n}\n    \n/**\n* 统计登陆的次数\n*/\n@Counted\npublic void userLogin(){\n}\n\n//other\n@CachedGauge @Gauge @ExceptionMetered @Metered @Metric\n``` \n\n### metrics上报\n#### ConsoleReporter\n对于简单指标的计算，可以使用定期向控制台报告：\n\n```\nfinal ConsoleReporter reporter = ConsoleReporter.forRegistry(metrics)\n\t\t\t\t                    .convertRatesTo(TimeUnit.SECONDS)\n\t\t\t\t                    .convertDurationsTo(TimeUnit.MILLISECONDS).build();\nmetrics.register(\"jvm.mem\", new MemoryUsageGaugeSet());\nmetrics.register(\"jvm.gc\", new GarbageCollectorMetricSet());\n                                                \nreporter.start(5, TimeUnit.MINUTES);\n```\n\n#### JmxReporter\n使用Jmx上报数据，转化为MBean，注：不建议在生产环境中使用，JMX的RPC API是不可靠的，但为了开发和浏览可选可视化工具：\n\n```\nfinal JmxReporter reporter = JmxReporter.forRegistry(registry).build();\nreporter.start();\n```\n\n#### CsvReporter\n对于相对复杂的指标，可将同一个metric创建.csv文件，并将定期上报的数据按新行写入：\n\n```\nfinal CsvReporter reporter = CsvReporter.forRegistry(registry)\n                                        .formatFor(Locale.US)\n                                        .convertRatesTo(TimeUnit.SECONDS)\n                                        .convertDurationsTo(TimeUnit.MILLISECONDS)\n                                        .build(new File(\"~/projects/data/\"));\nreporter.start(1, TimeUnit.SECONDS);\n```\n\n#### Slf4jReporter\n可以将上报数据记录slf4j日志：\n\n```\nfinal Slf4jReporter reporter = Slf4jReporter.forRegistry(registry)\n                                            .outputTo(LoggerFactory.getLogger(\"com.example.metrics\"))\n                                            .convertRatesTo(TimeUnit.SECONDS)\n                                            .convertDurationsTo(TimeUnit.MILLISECONDS)\n                                            .build();\nreporter.start(1, TimeUnit.MINUTES);\n```\n\n#### HTTP Reporter\n需搭建web服务，新增Listener事件，完成相应metrics指标注册，目前支持HealthCheckServlet，ThreadDumpServlet，MetricsServlet，PingServlet四类，最后启动服务即可请求获取Json格式的监控数据。实现详情如下：\n\n```\npublic class MyMetricsServletListener extends MetricsServlet.ContextListener {\n\t\n\tpublic static final MetricRegistry metrics = new MetricRegistry();\n\n\t@Override\n\tprotected MetricRegistry getMetricRegistry() {\n\t\t\n\t\tmetrics.register(\"jvm.mem\", new MemoryUsageGaugeSet());\n\t\tmetrics.register(\"jvm.gc\", new GarbageCollectorMetricSet());\n\t\tSystem.out.println(\">>.Listener success...\");\n\t\treturn metrics;\n\t}\n}\n```\n\n```\npublic class MyHealthCheckServletListener extends HealthCheckServlet.ContextListener {\n\n\tpublic static final HealthCheckRegistry healthCheck = new HealthCheckRegistry();\n\t@Override\n\tprotected HealthCheckRegistry getHealthCheckRegistry() {\n\t\t\n\t\thealthCheck.register(\"postgres\", new TFHealthCheck(false));\n\t\treturn healthCheck;\n\t}\n}\n```\n\n```\n\t<listener>\n        <listener-class>com.immomo.hubble.kafka.servlet.MyMetricsServletListener</listener-class>\n\t</listener>\n\t<listener>\n        <listener-class>com.immomo.hubble.kafka.servlet.MyHealthCheckServletListener</listener-class>\n\t</listener>\n\t\n\t<servlet>\n        <servlet-name>metrics</servlet-name>\n        <servlet-class>com.codahale.metrics.servlets.AdminServlet</servlet-class>\n\t</servlet>\n\t<servlet-mapping>\n\t   <servlet-name>metrics</servlet-name>\n\t   <url-pattern>/metrics/*</url-pattern>\n\t</servlet-mapping>\n```\n\n[源码地址](https://github.com/dropwizard/metrics)\n\n\n### Kafka性能指标\n#### kafka.server\nBrokerTopicMetrics,name=MessagesInPerSec: 每秒消息量\nBrokerTopicMetrics,name=BytesInPerSec: 每秒输入字节数\nBrokerTopicMetrics,name=BytesOutPerSec: 每秒输出字节数\nReplicaManager,name=UnderReplicatedPartitions: 复制分区的数量，默认0，|ISR|<|all replicas|\nReplicaManager,name=PartitionCount: 分区数\nReplicaManager,name=LeaderCount: Leader副本数\nReplicaManager,name=IsrShrinksPerSec: ISR回退\nReplicaManager,name=IsrExpandsPerSec: ISR超前 value is 0\nReplicaFetcherManager,name=MaxLag,clientId=Replica: 滞后follower和leader的最大消息长度\nFetcherLagMetrics,name=ConsumerLag,clientId=([-.\\w]+),topic=([-.\\w]+),partition=([0-9]+): 滞后follower的消息长度\nDelayedOperationPurgatory,name=PurgatorySize,delayedOperation=Produce: producer等待请求大小\nDelayedOperationPurgatory,name=PurgatorySize,delayedOperation=Fetch: 获取等待请求大小\nKafkaRequestHandlerPool,name=RequestHandlerAvgIdlePercent: 平均处理线程空闲时间\n\n#### kafka.network\nkafka.network:type=RequestMetrics,name=$1,request={Produce|FetchConsumer|FetchFollower}\nRequestsPerSec: 每秒请求量\nTotalTimeMs: 请求总时间\nRequestQueueTimeMs: 请求队列等待时间\nLocalTimeMs: 请求leader处理时间\nRemoteTimeMs: 请求follower等待时间\nResponseQueueTimeMs: 请求队列等待响应时间\nResponseSendTimeMs: 请求响应发送时间\nkafka.network:type=SocketServer,name=NetworkProcessorAvgIdlePercent: 平均网络处理空闲时间\n    \n#### kafka.controller\nKafkaController,name=ActiveControllerCount: 活跃broker数量\nControllerStats,name=LeaderElectionRateAndTimeMs: leader选举率\nControllerStats,name=UncleanLeaderElectionsPerSec: Unclean leader选举率\n\n#### common\nconnection-close-rate: 每秒连接关闭率\nconnection-creation-rate: 每秒新建连接率\nnetwork-io-rate: 平均每秒IO次数（读取或写入）\noutgoing-byte-rat: 平均每秒向服务器发送的字节数\nrequest-rate: 平均每秒发送的请求数\nincoming-byte-rate: 每秒读取字节数\nresponse-rate: 每秒收到的回复\nselect-rate: IO切换次数\nio-wait-ratio: IO线程等待时间\nconnection-count: 当前活跃连接数\n    \n#### broker\noutgoing-byte-rate: 平均每秒发送字节数\nrequest-rate: 平均每秒请求数\nrequest-size-avg: 所有请求的平均大小\nrequest-latency-avg: 平均请求时间(ms)\nresponse-rate: 每秒收到的响应数\n    \n#### producer\nwaiting-threads: 缓存区排队的用户阻塞线程数\nbuffer-available-bytes: 可用内存字节数\nbatch-size-avg: 每个分区每次请求发送的平均字节数\ncompression-rate-avg: 批量记录平均压缩率\nrecord-queue-time-avg: 批量记录耗费的平均时间（ms）\nrequest-latency-avg: 平均请求时间（ms）\nrecord-send-rate: 每秒发送的平均次数\nrecord-retry-rate: 每秒重试发送次数\nrecord-error-rate: 每秒错误数量次数\nrequests-in-flight: 目前等待响应的请求数量\nmetadata-age: 当前生产者数据使用周期（s）\n    \n#### consumer\n##### Consumer Group\ncommit-latency-avg: 提交请求所用的平均时间\ncommit-rate: 每秒提交调用次数\nassigned-partitions: 当前分配给该消费者的分区数（可选）\nheartbeat-rate: 平均每秒心跳数\njoin-time-avg: 群组重新加入的平均时间\njoin-rate: 每秒连接组的数量\nsync-time-avg: 群组同步所需的平均时间\nsync-rate: 每秒同步的组数\n    \n##### consumer fetch\nfetch-size-avg: 每次请求获取的平均字节数\nbytes-consumed-rate: 每秒消耗的平均字节数\nfetch-latency-avg: 请求所用的平均时间\nfetch-rate: 每秒提取请求数\nrecords-lag-max: 分区中记录的最大滞后数量\n    \n##### topic-level fetch\nfetch-size-avg: topic请求的平均字节数\nbytes-consumed-rate: topic每秒平均消耗的字节数\n\n#### streams\n##### Thread\n[commit|poll|process|punctuate]-latency-avg: 平均执行时间（ms）\n[commit|poll|process|punctuate]-rate: 平均每秒请求数\ntask-created-rate: 每秒新建任务数\ntask-closed-rate: 每秒关闭任务数\nskipped-records-rate: 每秒跳过记录数\n    \n##### Task\ncommit-latency-avg: 平均执行时间（ms）\ncommit-rate: 每秒提交的平均次数\n\n##### Processor Node\nforward-rate: 每秒从源节点向下游转发的平均速率\n\n##### State Store \n[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-latency-avg: 平均执行时间（ns）\n[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-rate: 每秒的平均运行速度\n\n#### others\nGC、CPU、IO等\n\n### Monitoring实现\n#### 方式一：\n1.提供Web服务支持，执行监听器注册我们需要监控的指标，可按Json格式输出\n2.启动后台进程定期通过Http请求抓取指标，并上报数据到redis队列\n3.storm消费数据进行分析计算\n\n```\n需多依赖\n<dependency>\n    <groupId>io.dropwizard.metrics</groupId>\n    <artifactId>metrics-servlets</artifactId>\n    <version>3.1.0</version>\n</dependency>\n```\n\n#### 方式二：\n1.重写KafkaReporter继承ScheduledReporter，构造相应指标，格式化、序列化Json，通过metrics收集统计结果\n2.创建kafkaProducer将构造的结果数据按不同Topic分类发送给kafka\n3.storm消费对应kafka数据，再进行分析计算\n\nPom依赖：\n\n```\n<dependency>\n    <groupId>org.apache.kafka</groupId>\n    <artifactId>kafka_2.11</artifactId>\n    <version>0.10.2.1</version>\n    <exclusions>\n        <exclusion>\n            <groupId>org.apache.zookeeper</groupId>\n            <artifactId>zookeeper</artifactId>\n\t\t\t</exclusion>\n    </exclusions>\n</dependency>\n<dependency>\n    <groupId>org.apache.zookeeper</groupId>\n    <artifactId>zookeeper</artifactId>\n    <version>3.4.10</version>\n    <exclusions>\n        <exclusion>\n            <groupId>com.sun.jmx</groupId>\n            <artifactId>jmxri</artifactId>\n        </exclusion>\n\t\t\t<exclusion>\n\t\t\t\t<groupId>com.sun.jdmk</groupId>\n\t\t\t\t<artifactId>jmxtools</artifactId>\n\t\t\t</exclusion>\n\t\t\t<exclusion>\n\t\t\t\t<groupId>javax.jms</groupId>\n\t\t\t\t<artifactId>jms</artifactId>\n\t\t\t</exclusion>\n\t\t</exclusions>\n\t</dependency>\n\t<dependency>\n\t       <groupId>io.dropwizard.metrics</groupId>\n\t       <artifactId>metrics-core</artifactId>\n\t       <version>3.1.0</version>\n\t</dependency>\n```\n\n### Kafka监控工具\n#### KafkaOffsetMonitor\n> 是由Kafka开源社区提供的一款Web管理界面，配置操作简单，界面简单，但不能自动刷新，但功能覆盖不全\n> 可以对consumer消费情况进行监控，并能列出每个consumer的offset数据\n> 可以查看每个topic的partition的列表（topic，pid，offset，logsize，lag，owner等）\n> 可以查看每个consumser group列表信息\n> 可以查看topic的历史消费信息\n> [源码地址](https://github.com/quantifind/KafkaOffsetMonitor)\n    \n#### kafka-web-console\n> 也是kafka开源的web监控程序，Scala编写，编译搭建相对于前者更复杂，默认用的数据库是H2，但可自动刷新。\n> 可以查看brokers kafka集群信息\n> 可以查看每个topic的Partition，logsize，分区leader等信息\n> 可以查看consumer group的partition，offset，lag，owner等信息；topic feed最新发布消息\n> 可以查看consumer偏移和滞后情况，历史消息以及consumer/producer消息吞吐量历史的图表\n> 控制台还提供了RAML中描述的JSON API\n> [源码地址](https://github.com/claudemamo/kafka-web-console)\n\n#### kafka-manger\n> 是由yahoo构建一款基于web的kafka管理器，可以管理多个kafka集群，且容易检测集群（topics,brokers,备份,分区）分布不均的情况\n> 可以选择你要运行的副本\n> 可以基于当前分区状况重新分配生成分区\n> 可以选择topic配置并创建topic(0.8.1.1和0.8.2+的配置不同)\n> 可以删除topic(只支持0.8.2+的版本并且要在broker配置中设置delete.topic.enable=true)，Topic list会指明哪些topic被删除\n> 可以为已存在的topic增加分区，更新配置\n> 可以支持多个topic批量重分区，选择partition broker位置等\n> 可以启用JMX轮询代理，以及broker、metrics主题等级\n> 可选地筛选出zookeeper中没有ids/owner/＆offset/目录的消费者\n> [源码地址](https://github.com/yahoo/kafka-manager)\n\n## QA\n**欢迎大家共同讨论、分享**\n\n\n\n","slug":"kafka_metrics","published":1,"date":"2019-11-23T13:27:27.070Z","updated":"2019-11-23T13:27:27.070Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ckiev8tmo0001lgjk1ajb450b","content":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><blockquote>\n<p>本次主要介绍关键的Kafka性能指标，Kafka metrics不同收集方式及数据上报的实现，最后确保达到有效监控Kafka工作状态的目的.</p>\n</blockquote>\n<h2 id=\"Kafka-metrics\"><a href=\"#Kafka-metrics\" class=\"headerlink\" title=\"Kafka metrics\"></a>Kafka metrics</h2><p>Kafka使用Yammer Metrics来上报服务端和客户端的Metric信息，通过配置采集相应数据上报监控系统，展示可视化结果。<br>Yammer Metrics提供6种形式的Metrics收集 —— Gauges，Counters，Histograms，Timers，Health Checks，Metrics Annotation。<br>Yammer Metrics将Metrics收集与上报分离，可以根据需要自由组合。目前支持的Reporter有Console Reporter，JMX Reporter，CSV Reporter，SLF4J Reporter，HTTP Reporter，Ganglia Reporter，Graphite Reporter。<br>因此，Kafka将可以通过以上组合输出我们想要的Metrics数据。</p>\n<h3 id=\"metrics收集\"><a href=\"#metrics收集\" class=\"headerlink\" title=\"metrics收集\"></a>metrics收集</h3><h4 id=\"注册\"><a href=\"#注册\" class=\"headerlink\" title=\"注册\"></a>注册</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">final MetricRegistry metrics &#x3D; new MetricRegistry();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Gauges\"><a href=\"#Gauges\" class=\"headerlink\" title=\"Gauges\"></a>Gauges</h4><p>gauge是一个数值的瞬时测量。比如我们可能需要衡量队列中待处理作业的数量：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class QueueManager &#123;</span><br><span class=\"line\">    private final Queue queue;</span><br><span class=\"line\">    public QueueManager(MetricRegistry metrics, String name) &#123;</span><br><span class=\"line\">        this.queue &#x3D; new Queue();</span><br><span class=\"line\">        &#x2F;&#x2F; name(QueueManager.class, name, &quot;size&quot;) 中间按.分隔</span><br><span class=\"line\">        metrics.register(MetricRegistry.name(QueueManager.class, name, &quot;size&quot;),</span><br><span class=\"line\">                         new Gauge&lt;Integer&gt;() &#123;</span><br><span class=\"line\">                             @Override</span><br><span class=\"line\">                             public Integer getValue() &#123;</span><br><span class=\"line\">                                 return queue.size();</span><br><span class=\"line\">                             &#125;</span><br><span class=\"line\">                         &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Counters\"><a href=\"#Counters\" class=\"headerlink\" title=\"Counters\"></a>Counters</h4><p>counter是AtomicLong类型的gauge，你可以增加或减少其值。比如我们可能需要更有效的统计阻塞在队列里job的数量：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final Counter pendingJobs &#x3D; metrics.counter(name(QueueManager.class, &quot;pending-jobs&quot;));</span><br><span class=\"line\">public void addJob(Job job) &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; 自增</span><br><span class=\"line\">    pendingJobs.inc();</span><br><span class=\"line\">    queue.offer(job);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">public Job takeJob() &#123;</span><br><span class=\"line\">    pendingJobs.dec();</span><br><span class=\"line\">    return queue.take();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">MetricRegistry.name(QueueManager.class, &quot;jobs&quot;, &quot;size&quot;)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Histograms\"><a href=\"#Histograms\" class=\"headerlink\" title=\"Histograms\"></a>Histograms</h4><p>histogram统计数据的分布，比如min,max,mean,stddev,median,P75,P90,P95,P98,P99,P99.9等的值</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final Histogram responseSizes &#x3D; metrics.histogram(name(RequestHandler.class, &quot;response-sizes&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">public void handleRequest(Request request, Response response) &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; 增加上报的值</span><br><span class=\"line\">    responseSizes.update(response.getContent().length);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Timers\"><a href=\"#Timers\" class=\"headerlink\" title=\"Timers\"></a>Timers</h4><p>Timer统计一个特定的代码片段被调用的速率和其持续时间的分布，比如统计response的耗时：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final Timer responses &#x3D; metrics.timer(name(RequestHandler.class, &quot;responses&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">public String handleRequest(Request request, Response response) &#123;</span><br><span class=\"line\">    final Timer.Context context &#x3D; responses.time();</span><br><span class=\"line\">    try &#123;</span><br><span class=\"line\">        &#x2F;&#x2F; 具体执行逻辑</span><br><span class=\"line\">        return &quot;OK&quot;;</span><br><span class=\"line\">    &#125; finally &#123;</span><br><span class=\"line\">        context.stop();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Health-Checks\"><a href=\"#Health-Checks\" class=\"headerlink\" title=\"Health Checks\"></a>Health Checks</h4><p>主要用户可以自己判断系统的健康状态，比如判断数据库是否连接正常：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">final HealthCheckRegistry healthChecks &#x3D; new HealthCheckRegistry();</span><br><span class=\"line\"></span><br><span class=\"line\">public class DatabaseHealthCheck extends HealthCheck &#123;</span><br><span class=\"line\">    private final Database database;</span><br><span class=\"line\"></span><br><span class=\"line\">    public DatabaseHealthCheck(Database database) &#123;</span><br><span class=\"line\">        this.database &#x3D; database;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    public HealthCheck.Result check() throws Exception &#123;</span><br><span class=\"line\">        if (database.isConnected()) &#123;</span><br><span class=\"line\">            return HealthCheck.Result.healthy();</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            return HealthCheck.Result.unhealthy(&quot;Cannot connect to &quot; + database.getUrl());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">healthChecks.register(&quot;postgres&quot;, new DatabaseHealthCheck(database));</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Metrics-Annotation\"><a href=\"#Metrics-Annotation\" class=\"headerlink\" title=\"Metrics Annotation\"></a>Metrics Annotation</h4><p>注解方式，简单的实现统计某个方法、某个值的数据：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;**</span><br><span class=\"line\">* 统计调用的次数和时间</span><br><span class=\"line\">*&#x2F;</span><br><span class=\"line\">@Timed</span><br><span class=\"line\">public void call() &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#x2F;**</span><br><span class=\"line\">* 统计登陆的次数</span><br><span class=\"line\">*&#x2F;</span><br><span class=\"line\">@Counted</span><br><span class=\"line\">public void userLogin()&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;other</span><br><span class=\"line\">@CachedGauge @Gauge @ExceptionMetered @Metered @Metric</span><br><span class=\"line\">&#96;&#96;&#96; </span><br><span class=\"line\"></span><br><span class=\"line\">### metrics上报</span><br><span class=\"line\">#### ConsoleReporter</span><br><span class=\"line\">对于简单指标的计算，可以使用定期向控制台报告：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final ConsoleReporter reporter = ConsoleReporter.forRegistry(metrics)<br>                                    .convertRatesTo(TimeUnit.SECONDS)<br>                                    .convertDurationsTo(TimeUnit.MILLISECONDS).build();<br>metrics.register(“jvm.mem”, new MemoryUsageGaugeSet());<br>metrics.register(“jvm.gc”, new GarbageCollectorMetricSet());</p>\n<p>reporter.start(5, TimeUnit.MINUTES);</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### JmxReporter</span><br><span class=\"line\">使用Jmx上报数据，转化为MBean，注：不建议在生产环境中使用，JMX的RPC API是不可靠的，但为了开发和浏览可选可视化工具：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final JmxReporter reporter = JmxReporter.forRegistry(registry).build();<br>reporter.start();</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### CsvReporter</span><br><span class=\"line\">对于相对复杂的指标，可将同一个metric创建.csv文件，并将定期上报的数据按新行写入：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final CsvReporter reporter = CsvReporter.forRegistry(registry)<br>                                        .formatFor(Locale.US)<br>                                        .convertRatesTo(TimeUnit.SECONDS)<br>                                        .convertDurationsTo(TimeUnit.MILLISECONDS)<br>                                        .build(new File(“~/projects/data/“));<br>reporter.start(1, TimeUnit.SECONDS);</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### Slf4jReporter</span><br><span class=\"line\">可以将上报数据记录slf4j日志：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final Slf4jReporter reporter = Slf4jReporter.forRegistry(registry)<br>                                            .outputTo(LoggerFactory.getLogger(“com.example.metrics”))<br>                                            .convertRatesTo(TimeUnit.SECONDS)<br>                                            .convertDurationsTo(TimeUnit.MILLISECONDS)<br>                                            .build();<br>reporter.start(1, TimeUnit.MINUTES);</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### HTTP Reporter</span><br><span class=\"line\">需搭建web服务，新增Listener事件，完成相应metrics指标注册，目前支持HealthCheckServlet，ThreadDumpServlet，MetricsServlet，PingServlet四类，最后启动服务即可请求获取Json格式的监控数据。实现详情如下：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>public class MyMetricsServletListener extends MetricsServlet.ContextListener {</p>\n<pre><code>public static final MetricRegistry metrics = new MetricRegistry();\n\n@Override\nprotected MetricRegistry getMetricRegistry() &#123;\n\n    metrics.register(&quot;jvm.mem&quot;, new MemoryUsageGaugeSet());\n    metrics.register(&quot;jvm.gc&quot;, new GarbageCollectorMetricSet());\n    System.out.println(&quot;&gt;&gt;.Listener success...&quot;);\n    return metrics;\n&#125;</code></pre>\n<p>}</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>public class MyHealthCheckServletListener extends HealthCheckServlet.ContextListener {</p>\n<pre><code>public static final HealthCheckRegistry healthCheck = new HealthCheckRegistry();\n@Override\nprotected HealthCheckRegistry getHealthCheckRegistry() &#123;\n\n    healthCheck.register(&quot;postgres&quot;, new TFHealthCheck(false));\n    return healthCheck;\n&#125;</code></pre>\n<p>}</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<pre><code>&lt;listener&gt;\n    &lt;listener-class&gt;com.immomo.hubble.kafka.servlet.MyMetricsServletListener&lt;/listener-class&gt;\n&lt;/listener&gt;\n&lt;listener&gt;\n    &lt;listener-class&gt;com.immomo.hubble.kafka.servlet.MyHealthCheckServletListener&lt;/listener-class&gt;\n&lt;/listener&gt;\n\n&lt;servlet&gt;\n    &lt;servlet-name&gt;metrics&lt;/servlet-name&gt;\n    &lt;servlet-class&gt;com.codahale.metrics.servlets.AdminServlet&lt;/servlet-class&gt;\n&lt;/servlet&gt;\n&lt;servlet-mapping&gt;\n   &lt;servlet-name&gt;metrics&lt;/servlet-name&gt;\n   &lt;url-pattern&gt;/metrics/*&lt;/url-pattern&gt;\n&lt;/servlet-mapping&gt;</code></pre>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">[源码地址](https:&#x2F;&#x2F;github.com&#x2F;dropwizard&#x2F;metrics)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### Kafka性能指标</span><br><span class=\"line\">#### kafka.server</span><br><span class=\"line\">BrokerTopicMetrics,name&#x3D;MessagesInPerSec: 每秒消息量</span><br><span class=\"line\">BrokerTopicMetrics,name&#x3D;BytesInPerSec: 每秒输入字节数</span><br><span class=\"line\">BrokerTopicMetrics,name&#x3D;BytesOutPerSec: 每秒输出字节数</span><br><span class=\"line\">ReplicaManager,name&#x3D;UnderReplicatedPartitions: 复制分区的数量，默认0，|ISR|&lt;|all replicas|</span><br><span class=\"line\">ReplicaManager,name&#x3D;PartitionCount: 分区数</span><br><span class=\"line\">ReplicaManager,name&#x3D;LeaderCount: Leader副本数</span><br><span class=\"line\">ReplicaManager,name&#x3D;IsrShrinksPerSec: ISR回退</span><br><span class=\"line\">ReplicaManager,name&#x3D;IsrExpandsPerSec: ISR超前 value is 0</span><br><span class=\"line\">ReplicaFetcherManager,name&#x3D;MaxLag,clientId&#x3D;Replica: 滞后follower和leader的最大消息长度</span><br><span class=\"line\">FetcherLagMetrics,name&#x3D;ConsumerLag,clientId&#x3D;([-.\\w]+),topic&#x3D;([-.\\w]+),partition&#x3D;([0-9]+): 滞后follower的消息长度</span><br><span class=\"line\">DelayedOperationPurgatory,name&#x3D;PurgatorySize,delayedOperation&#x3D;Produce: producer等待请求大小</span><br><span class=\"line\">DelayedOperationPurgatory,name&#x3D;PurgatorySize,delayedOperation&#x3D;Fetch: 获取等待请求大小</span><br><span class=\"line\">KafkaRequestHandlerPool,name&#x3D;RequestHandlerAvgIdlePercent: 平均处理线程空闲时间</span><br><span class=\"line\"></span><br><span class=\"line\">#### kafka.network</span><br><span class=\"line\">kafka.network:type&#x3D;RequestMetrics,name&#x3D;$1,request&#x3D;&#123;Produce|FetchConsumer|FetchFollower&#125;</span><br><span class=\"line\">RequestsPerSec: 每秒请求量</span><br><span class=\"line\">TotalTimeMs: 请求总时间</span><br><span class=\"line\">RequestQueueTimeMs: 请求队列等待时间</span><br><span class=\"line\">LocalTimeMs: 请求leader处理时间</span><br><span class=\"line\">RemoteTimeMs: 请求follower等待时间</span><br><span class=\"line\">ResponseQueueTimeMs: 请求队列等待响应时间</span><br><span class=\"line\">ResponseSendTimeMs: 请求响应发送时间</span><br><span class=\"line\">kafka.network:type&#x3D;SocketServer,name&#x3D;NetworkProcessorAvgIdlePercent: 平均网络处理空闲时间</span><br><span class=\"line\">    </span><br><span class=\"line\">#### kafka.controller</span><br><span class=\"line\">KafkaController,name&#x3D;ActiveControllerCount: 活跃broker数量</span><br><span class=\"line\">ControllerStats,name&#x3D;LeaderElectionRateAndTimeMs: leader选举率</span><br><span class=\"line\">ControllerStats,name&#x3D;UncleanLeaderElectionsPerSec: Unclean leader选举率</span><br><span class=\"line\"></span><br><span class=\"line\">#### common</span><br><span class=\"line\">connection-close-rate: 每秒连接关闭率</span><br><span class=\"line\">connection-creation-rate: 每秒新建连接率</span><br><span class=\"line\">network-io-rate: 平均每秒IO次数（读取或写入）</span><br><span class=\"line\">outgoing-byte-rat: 平均每秒向服务器发送的字节数</span><br><span class=\"line\">request-rate: 平均每秒发送的请求数</span><br><span class=\"line\">incoming-byte-rate: 每秒读取字节数</span><br><span class=\"line\">response-rate: 每秒收到的回复</span><br><span class=\"line\">select-rate: IO切换次数</span><br><span class=\"line\">io-wait-ratio: IO线程等待时间</span><br><span class=\"line\">connection-count: 当前活跃连接数</span><br><span class=\"line\">    </span><br><span class=\"line\">#### broker</span><br><span class=\"line\">outgoing-byte-rate: 平均每秒发送字节数</span><br><span class=\"line\">request-rate: 平均每秒请求数</span><br><span class=\"line\">request-size-avg: 所有请求的平均大小</span><br><span class=\"line\">request-latency-avg: 平均请求时间(ms)</span><br><span class=\"line\">response-rate: 每秒收到的响应数</span><br><span class=\"line\">    </span><br><span class=\"line\">#### producer</span><br><span class=\"line\">waiting-threads: 缓存区排队的用户阻塞线程数</span><br><span class=\"line\">buffer-available-bytes: 可用内存字节数</span><br><span class=\"line\">batch-size-avg: 每个分区每次请求发送的平均字节数</span><br><span class=\"line\">compression-rate-avg: 批量记录平均压缩率</span><br><span class=\"line\">record-queue-time-avg: 批量记录耗费的平均时间（ms）</span><br><span class=\"line\">request-latency-avg: 平均请求时间（ms）</span><br><span class=\"line\">record-send-rate: 每秒发送的平均次数</span><br><span class=\"line\">record-retry-rate: 每秒重试发送次数</span><br><span class=\"line\">record-error-rate: 每秒错误数量次数</span><br><span class=\"line\">requests-in-flight: 目前等待响应的请求数量</span><br><span class=\"line\">metadata-age: 当前生产者数据使用周期（s）</span><br><span class=\"line\">    </span><br><span class=\"line\">#### consumer</span><br><span class=\"line\">##### Consumer Group</span><br><span class=\"line\">commit-latency-avg: 提交请求所用的平均时间</span><br><span class=\"line\">commit-rate: 每秒提交调用次数</span><br><span class=\"line\">assigned-partitions: 当前分配给该消费者的分区数（可选）</span><br><span class=\"line\">heartbeat-rate: 平均每秒心跳数</span><br><span class=\"line\">join-time-avg: 群组重新加入的平均时间</span><br><span class=\"line\">join-rate: 每秒连接组的数量</span><br><span class=\"line\">sync-time-avg: 群组同步所需的平均时间</span><br><span class=\"line\">sync-rate: 每秒同步的组数</span><br><span class=\"line\">    </span><br><span class=\"line\">##### consumer fetch</span><br><span class=\"line\">fetch-size-avg: 每次请求获取的平均字节数</span><br><span class=\"line\">bytes-consumed-rate: 每秒消耗的平均字节数</span><br><span class=\"line\">fetch-latency-avg: 请求所用的平均时间</span><br><span class=\"line\">fetch-rate: 每秒提取请求数</span><br><span class=\"line\">records-lag-max: 分区中记录的最大滞后数量</span><br><span class=\"line\">    </span><br><span class=\"line\">##### topic-level fetch</span><br><span class=\"line\">fetch-size-avg: topic请求的平均字节数</span><br><span class=\"line\">bytes-consumed-rate: topic每秒平均消耗的字节数</span><br><span class=\"line\"></span><br><span class=\"line\">#### streams</span><br><span class=\"line\">##### Thread</span><br><span class=\"line\">[commit|poll|process|punctuate]-latency-avg: 平均执行时间（ms）</span><br><span class=\"line\">[commit|poll|process|punctuate]-rate: 平均每秒请求数</span><br><span class=\"line\">task-created-rate: 每秒新建任务数</span><br><span class=\"line\">task-closed-rate: 每秒关闭任务数</span><br><span class=\"line\">skipped-records-rate: 每秒跳过记录数</span><br><span class=\"line\">    </span><br><span class=\"line\">##### Task</span><br><span class=\"line\">commit-latency-avg: 平均执行时间（ms）</span><br><span class=\"line\">commit-rate: 每秒提交的平均次数</span><br><span class=\"line\"></span><br><span class=\"line\">##### Processor Node</span><br><span class=\"line\">forward-rate: 每秒从源节点向下游转发的平均速率</span><br><span class=\"line\"></span><br><span class=\"line\">##### State Store </span><br><span class=\"line\">[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-latency-avg: 平均执行时间（ns）</span><br><span class=\"line\">[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-rate: 每秒的平均运行速度</span><br><span class=\"line\"></span><br><span class=\"line\">#### others</span><br><span class=\"line\">GC、CPU、IO等</span><br><span class=\"line\"></span><br><span class=\"line\">### Monitoring实现</span><br><span class=\"line\">#### 方式一：</span><br><span class=\"line\">1.提供Web服务支持，执行监听器注册我们需要监控的指标，可按Json格式输出</span><br><span class=\"line\">2.启动后台进程定期通过Http请求抓取指标，并上报数据到redis队列</span><br><span class=\"line\">3.storm消费数据进行分析计算</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>需多依赖<br><dependency><br>    <groupId>io.dropwizard.metrics</groupId><br>    <artifactId>metrics-servlets</artifactId><br>    <version>3.1.0</version><br></dependency></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### 方式二：</span><br><span class=\"line\">1.重写KafkaReporter继承ScheduledReporter，构造相应指标，格式化、序列化Json，通过metrics收集统计结果</span><br><span class=\"line\">2.创建kafkaProducer将构造的结果数据按不同Topic分类发送给kafka</span><br><span class=\"line\">3.storm消费对应kafka数据，再进行分析计算</span><br><span class=\"line\"></span><br><span class=\"line\">Pom依赖：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<dependency>\n    <groupId>org.apache.kafka</groupId>\n    <artifactId>kafka_2.11</artifactId>\n    <version>0.10.2.1</version>\n    <exclusions>\n        <exclusion>\n            <groupId>org.apache.zookeeper</groupId>\n            <artifactId>zookeeper</artifactId>\n            </exclusion>\n    </exclusions>\n</dependency>\n<dependency>\n    <groupId>org.apache.zookeeper</groupId>\n    <artifactId>zookeeper</artifactId>\n    <version>3.4.10</version>\n    <exclusions>\n        <exclusion>\n            <groupId>com.sun.jmx</groupId>\n            <artifactId>jmxri</artifactId>\n        </exclusion>\n            <exclusion>\n                <groupId>com.sun.jdmk</groupId>\n                <artifactId>jmxtools</artifactId>\n            </exclusion>\n            <exclusion>\n                <groupId>javax.jms</groupId>\n                <artifactId>jms</artifactId>\n            </exclusion>\n        </exclusions>\n    </dependency>\n    <dependency>\n           <groupId>io.dropwizard.metrics</groupId>\n           <artifactId>metrics-core</artifactId>\n           <version>3.1.0</version>\n    </dependency>\n```\n\n<h3 id=\"Kafka监控工具\"><a href=\"#Kafka监控工具\" class=\"headerlink\" title=\"Kafka监控工具\"></a>Kafka监控工具</h3><h4 id=\"KafkaOffsetMonitor\"><a href=\"#KafkaOffsetMonitor\" class=\"headerlink\" title=\"KafkaOffsetMonitor\"></a>KafkaOffsetMonitor</h4><blockquote>\n<p>是由Kafka开源社区提供的一款Web管理界面，配置操作简单，界面简单，但不能自动刷新，但功能覆盖不全<br>可以对consumer消费情况进行监控，并能列出每个consumer的offset数据<br>可以查看每个topic的partition的列表（topic，pid，offset，logsize，lag，owner等）<br>可以查看每个consumser group列表信息<br>可以查看topic的历史消费信息<br><a href=\"https://github.com/quantifind/KafkaOffsetMonitor\">源码地址</a></p>\n</blockquote>\n<h4 id=\"kafka-web-console\"><a href=\"#kafka-web-console\" class=\"headerlink\" title=\"kafka-web-console\"></a>kafka-web-console</h4><blockquote>\n<p>也是kafka开源的web监控程序，Scala编写，编译搭建相对于前者更复杂，默认用的数据库是H2，但可自动刷新。<br>可以查看brokers kafka集群信息<br>可以查看每个topic的Partition，logsize，分区leader等信息<br>可以查看consumer group的partition，offset，lag，owner等信息；topic feed最新发布消息<br>可以查看consumer偏移和滞后情况，历史消息以及consumer/producer消息吞吐量历史的图表<br>控制台还提供了RAML中描述的JSON API<br><a href=\"https://github.com/claudemamo/kafka-web-console\">源码地址</a></p>\n</blockquote>\n<h4 id=\"kafka-manger\"><a href=\"#kafka-manger\" class=\"headerlink\" title=\"kafka-manger\"></a>kafka-manger</h4><blockquote>\n<p>是由yahoo构建一款基于web的kafka管理器，可以管理多个kafka集群，且容易检测集群（topics,brokers,备份,分区）分布不均的情况<br>可以选择你要运行的副本<br>可以基于当前分区状况重新分配生成分区<br>可以选择topic配置并创建topic(0.8.1.1和0.8.2+的配置不同)<br>可以删除topic(只支持0.8.2+的版本并且要在broker配置中设置delete.topic.enable=true)，Topic list会指明哪些topic被删除<br>可以为已存在的topic增加分区，更新配置<br>可以支持多个topic批量重分区，选择partition broker位置等<br>可以启用JMX轮询代理，以及broker、metrics主题等级<br>可选地筛选出zookeeper中没有ids/owner/＆offset/目录的消费者<br><a href=\"https://github.com/yahoo/kafka-manager\">源码地址</a></p>\n</blockquote>\n<h2 id=\"QA\"><a href=\"#QA\" class=\"headerlink\" title=\"QA\"></a>QA</h2><p><strong>欢迎大家共同讨论、分享</strong></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><blockquote>\n<p>本次主要介绍关键的Kafka性能指标，Kafka metrics不同收集方式及数据上报的实现，最后确保达到有效监控Kafka工作状态的目的.</p>\n</blockquote>\n<h2 id=\"Kafka-metrics\"><a href=\"#Kafka-metrics\" class=\"headerlink\" title=\"Kafka metrics\"></a>Kafka metrics</h2><p>Kafka使用Yammer Metrics来上报服务端和客户端的Metric信息，通过配置采集相应数据上报监控系统，展示可视化结果。<br>Yammer Metrics提供6种形式的Metrics收集 —— Gauges，Counters，Histograms，Timers，Health Checks，Metrics Annotation。<br>Yammer Metrics将Metrics收集与上报分离，可以根据需要自由组合。目前支持的Reporter有Console Reporter，JMX Reporter，CSV Reporter，SLF4J Reporter，HTTP Reporter，Ganglia Reporter，Graphite Reporter。<br>因此，Kafka将可以通过以上组合输出我们想要的Metrics数据。</p>\n<h3 id=\"metrics收集\"><a href=\"#metrics收集\" class=\"headerlink\" title=\"metrics收集\"></a>metrics收集</h3><h4 id=\"注册\"><a href=\"#注册\" class=\"headerlink\" title=\"注册\"></a>注册</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">final MetricRegistry metrics &#x3D; new MetricRegistry();</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Gauges\"><a href=\"#Gauges\" class=\"headerlink\" title=\"Gauges\"></a>Gauges</h4><p>gauge是一个数值的瞬时测量。比如我们可能需要衡量队列中待处理作业的数量：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class QueueManager &#123;</span><br><span class=\"line\">    private final Queue queue;</span><br><span class=\"line\">    public QueueManager(MetricRegistry metrics, String name) &#123;</span><br><span class=\"line\">        this.queue &#x3D; new Queue();</span><br><span class=\"line\">        &#x2F;&#x2F; name(QueueManager.class, name, &quot;size&quot;) 中间按.分隔</span><br><span class=\"line\">        metrics.register(MetricRegistry.name(QueueManager.class, name, &quot;size&quot;),</span><br><span class=\"line\">                         new Gauge&lt;Integer&gt;() &#123;</span><br><span class=\"line\">                             @Override</span><br><span class=\"line\">                             public Integer getValue() &#123;</span><br><span class=\"line\">                                 return queue.size();</span><br><span class=\"line\">                             &#125;</span><br><span class=\"line\">                         &#125;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Counters\"><a href=\"#Counters\" class=\"headerlink\" title=\"Counters\"></a>Counters</h4><p>counter是AtomicLong类型的gauge，你可以增加或减少其值。比如我们可能需要更有效的统计阻塞在队列里job的数量：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final Counter pendingJobs &#x3D; metrics.counter(name(QueueManager.class, &quot;pending-jobs&quot;));</span><br><span class=\"line\">public void addJob(Job job) &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; 自增</span><br><span class=\"line\">    pendingJobs.inc();</span><br><span class=\"line\">    queue.offer(job);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">public Job takeJob() &#123;</span><br><span class=\"line\">    pendingJobs.dec();</span><br><span class=\"line\">    return queue.take();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">MetricRegistry.name(QueueManager.class, &quot;jobs&quot;, &quot;size&quot;)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Histograms\"><a href=\"#Histograms\" class=\"headerlink\" title=\"Histograms\"></a>Histograms</h4><p>histogram统计数据的分布，比如min,max,mean,stddev,median,P75,P90,P95,P98,P99,P99.9等的值</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final Histogram responseSizes &#x3D; metrics.histogram(name(RequestHandler.class, &quot;response-sizes&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">public void handleRequest(Request request, Response response) &#123;</span><br><span class=\"line\">    &#x2F;&#x2F; 增加上报的值</span><br><span class=\"line\">    responseSizes.update(response.getContent().length);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Timers\"><a href=\"#Timers\" class=\"headerlink\" title=\"Timers\"></a>Timers</h4><p>Timer统计一个特定的代码片段被调用的速率和其持续时间的分布，比如统计response的耗时：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">private final Timer responses &#x3D; metrics.timer(name(RequestHandler.class, &quot;responses&quot;));</span><br><span class=\"line\"></span><br><span class=\"line\">public String handleRequest(Request request, Response response) &#123;</span><br><span class=\"line\">    final Timer.Context context &#x3D; responses.time();</span><br><span class=\"line\">    try &#123;</span><br><span class=\"line\">        &#x2F;&#x2F; 具体执行逻辑</span><br><span class=\"line\">        return &quot;OK&quot;;</span><br><span class=\"line\">    &#125; finally &#123;</span><br><span class=\"line\">        context.stop();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Health-Checks\"><a href=\"#Health-Checks\" class=\"headerlink\" title=\"Health Checks\"></a>Health Checks</h4><p>主要用户可以自己判断系统的健康状态，比如判断数据库是否连接正常：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">final HealthCheckRegistry healthChecks &#x3D; new HealthCheckRegistry();</span><br><span class=\"line\"></span><br><span class=\"line\">public class DatabaseHealthCheck extends HealthCheck &#123;</span><br><span class=\"line\">    private final Database database;</span><br><span class=\"line\"></span><br><span class=\"line\">    public DatabaseHealthCheck(Database database) &#123;</span><br><span class=\"line\">        this.database &#x3D; database;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    public HealthCheck.Result check() throws Exception &#123;</span><br><span class=\"line\">        if (database.isConnected()) &#123;</span><br><span class=\"line\">            return HealthCheck.Result.healthy();</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            return HealthCheck.Result.unhealthy(&quot;Cannot connect to &quot; + database.getUrl());</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">healthChecks.register(&quot;postgres&quot;, new DatabaseHealthCheck(database));</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"Metrics-Annotation\"><a href=\"#Metrics-Annotation\" class=\"headerlink\" title=\"Metrics Annotation\"></a>Metrics Annotation</h4><p>注解方式，简单的实现统计某个方法、某个值的数据：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x2F;**</span><br><span class=\"line\">* 统计调用的次数和时间</span><br><span class=\"line\">*&#x2F;</span><br><span class=\"line\">@Timed</span><br><span class=\"line\">public void call() &#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">&#x2F;**</span><br><span class=\"line\">* 统计登陆的次数</span><br><span class=\"line\">*&#x2F;</span><br><span class=\"line\">@Counted</span><br><span class=\"line\">public void userLogin()&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x2F;&#x2F;other</span><br><span class=\"line\">@CachedGauge @Gauge @ExceptionMetered @Metered @Metric</span><br><span class=\"line\">&#96;&#96;&#96; </span><br><span class=\"line\"></span><br><span class=\"line\">### metrics上报</span><br><span class=\"line\">#### ConsoleReporter</span><br><span class=\"line\">对于简单指标的计算，可以使用定期向控制台报告：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final ConsoleReporter reporter = ConsoleReporter.forRegistry(metrics)<br>                                    .convertRatesTo(TimeUnit.SECONDS)<br>                                    .convertDurationsTo(TimeUnit.MILLISECONDS).build();<br>metrics.register(“jvm.mem”, new MemoryUsageGaugeSet());<br>metrics.register(“jvm.gc”, new GarbageCollectorMetricSet());</p>\n<p>reporter.start(5, TimeUnit.MINUTES);</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### JmxReporter</span><br><span class=\"line\">使用Jmx上报数据，转化为MBean，注：不建议在生产环境中使用，JMX的RPC API是不可靠的，但为了开发和浏览可选可视化工具：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final JmxReporter reporter = JmxReporter.forRegistry(registry).build();<br>reporter.start();</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### CsvReporter</span><br><span class=\"line\">对于相对复杂的指标，可将同一个metric创建.csv文件，并将定期上报的数据按新行写入：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final CsvReporter reporter = CsvReporter.forRegistry(registry)<br>                                        .formatFor(Locale.US)<br>                                        .convertRatesTo(TimeUnit.SECONDS)<br>                                        .convertDurationsTo(TimeUnit.MILLISECONDS)<br>                                        .build(new File(“~/projects/data/“));<br>reporter.start(1, TimeUnit.SECONDS);</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### Slf4jReporter</span><br><span class=\"line\">可以将上报数据记录slf4j日志：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>final Slf4jReporter reporter = Slf4jReporter.forRegistry(registry)<br>                                            .outputTo(LoggerFactory.getLogger(“com.example.metrics”))<br>                                            .convertRatesTo(TimeUnit.SECONDS)<br>                                            .convertDurationsTo(TimeUnit.MILLISECONDS)<br>                                            .build();<br>reporter.start(1, TimeUnit.MINUTES);</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### HTTP Reporter</span><br><span class=\"line\">需搭建web服务，新增Listener事件，完成相应metrics指标注册，目前支持HealthCheckServlet，ThreadDumpServlet，MetricsServlet，PingServlet四类，最后启动服务即可请求获取Json格式的监控数据。实现详情如下：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>public class MyMetricsServletListener extends MetricsServlet.ContextListener {</p>\n<pre><code>public static final MetricRegistry metrics = new MetricRegistry();\n\n@Override\nprotected MetricRegistry getMetricRegistry() &#123;\n\n    metrics.register(&quot;jvm.mem&quot;, new MemoryUsageGaugeSet());\n    metrics.register(&quot;jvm.gc&quot;, new GarbageCollectorMetricSet());\n    System.out.println(&quot;&gt;&gt;.Listener success...&quot;);\n    return metrics;\n&#125;</code></pre>\n<p>}</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>public class MyHealthCheckServletListener extends HealthCheckServlet.ContextListener {</p>\n<pre><code>public static final HealthCheckRegistry healthCheck = new HealthCheckRegistry();\n@Override\nprotected HealthCheckRegistry getHealthCheckRegistry() &#123;\n\n    healthCheck.register(&quot;postgres&quot;, new TFHealthCheck(false));\n    return healthCheck;\n&#125;</code></pre>\n<p>}</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<pre><code>&lt;listener&gt;\n    &lt;listener-class&gt;com.immomo.hubble.kafka.servlet.MyMetricsServletListener&lt;/listener-class&gt;\n&lt;/listener&gt;\n&lt;listener&gt;\n    &lt;listener-class&gt;com.immomo.hubble.kafka.servlet.MyHealthCheckServletListener&lt;/listener-class&gt;\n&lt;/listener&gt;\n\n&lt;servlet&gt;\n    &lt;servlet-name&gt;metrics&lt;/servlet-name&gt;\n    &lt;servlet-class&gt;com.codahale.metrics.servlets.AdminServlet&lt;/servlet-class&gt;\n&lt;/servlet&gt;\n&lt;servlet-mapping&gt;\n   &lt;servlet-name&gt;metrics&lt;/servlet-name&gt;\n   &lt;url-pattern&gt;/metrics/*&lt;/url-pattern&gt;\n&lt;/servlet-mapping&gt;</code></pre>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">[源码地址](https:&#x2F;&#x2F;github.com&#x2F;dropwizard&#x2F;metrics)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">### Kafka性能指标</span><br><span class=\"line\">#### kafka.server</span><br><span class=\"line\">BrokerTopicMetrics,name&#x3D;MessagesInPerSec: 每秒消息量</span><br><span class=\"line\">BrokerTopicMetrics,name&#x3D;BytesInPerSec: 每秒输入字节数</span><br><span class=\"line\">BrokerTopicMetrics,name&#x3D;BytesOutPerSec: 每秒输出字节数</span><br><span class=\"line\">ReplicaManager,name&#x3D;UnderReplicatedPartitions: 复制分区的数量，默认0，|ISR|&lt;|all replicas|</span><br><span class=\"line\">ReplicaManager,name&#x3D;PartitionCount: 分区数</span><br><span class=\"line\">ReplicaManager,name&#x3D;LeaderCount: Leader副本数</span><br><span class=\"line\">ReplicaManager,name&#x3D;IsrShrinksPerSec: ISR回退</span><br><span class=\"line\">ReplicaManager,name&#x3D;IsrExpandsPerSec: ISR超前 value is 0</span><br><span class=\"line\">ReplicaFetcherManager,name&#x3D;MaxLag,clientId&#x3D;Replica: 滞后follower和leader的最大消息长度</span><br><span class=\"line\">FetcherLagMetrics,name&#x3D;ConsumerLag,clientId&#x3D;([-.\\w]+),topic&#x3D;([-.\\w]+),partition&#x3D;([0-9]+): 滞后follower的消息长度</span><br><span class=\"line\">DelayedOperationPurgatory,name&#x3D;PurgatorySize,delayedOperation&#x3D;Produce: producer等待请求大小</span><br><span class=\"line\">DelayedOperationPurgatory,name&#x3D;PurgatorySize,delayedOperation&#x3D;Fetch: 获取等待请求大小</span><br><span class=\"line\">KafkaRequestHandlerPool,name&#x3D;RequestHandlerAvgIdlePercent: 平均处理线程空闲时间</span><br><span class=\"line\"></span><br><span class=\"line\">#### kafka.network</span><br><span class=\"line\">kafka.network:type&#x3D;RequestMetrics,name&#x3D;$1,request&#x3D;&#123;Produce|FetchConsumer|FetchFollower&#125;</span><br><span class=\"line\">RequestsPerSec: 每秒请求量</span><br><span class=\"line\">TotalTimeMs: 请求总时间</span><br><span class=\"line\">RequestQueueTimeMs: 请求队列等待时间</span><br><span class=\"line\">LocalTimeMs: 请求leader处理时间</span><br><span class=\"line\">RemoteTimeMs: 请求follower等待时间</span><br><span class=\"line\">ResponseQueueTimeMs: 请求队列等待响应时间</span><br><span class=\"line\">ResponseSendTimeMs: 请求响应发送时间</span><br><span class=\"line\">kafka.network:type&#x3D;SocketServer,name&#x3D;NetworkProcessorAvgIdlePercent: 平均网络处理空闲时间</span><br><span class=\"line\">    </span><br><span class=\"line\">#### kafka.controller</span><br><span class=\"line\">KafkaController,name&#x3D;ActiveControllerCount: 活跃broker数量</span><br><span class=\"line\">ControllerStats,name&#x3D;LeaderElectionRateAndTimeMs: leader选举率</span><br><span class=\"line\">ControllerStats,name&#x3D;UncleanLeaderElectionsPerSec: Unclean leader选举率</span><br><span class=\"line\"></span><br><span class=\"line\">#### common</span><br><span class=\"line\">connection-close-rate: 每秒连接关闭率</span><br><span class=\"line\">connection-creation-rate: 每秒新建连接率</span><br><span class=\"line\">network-io-rate: 平均每秒IO次数（读取或写入）</span><br><span class=\"line\">outgoing-byte-rat: 平均每秒向服务器发送的字节数</span><br><span class=\"line\">request-rate: 平均每秒发送的请求数</span><br><span class=\"line\">incoming-byte-rate: 每秒读取字节数</span><br><span class=\"line\">response-rate: 每秒收到的回复</span><br><span class=\"line\">select-rate: IO切换次数</span><br><span class=\"line\">io-wait-ratio: IO线程等待时间</span><br><span class=\"line\">connection-count: 当前活跃连接数</span><br><span class=\"line\">    </span><br><span class=\"line\">#### broker</span><br><span class=\"line\">outgoing-byte-rate: 平均每秒发送字节数</span><br><span class=\"line\">request-rate: 平均每秒请求数</span><br><span class=\"line\">request-size-avg: 所有请求的平均大小</span><br><span class=\"line\">request-latency-avg: 平均请求时间(ms)</span><br><span class=\"line\">response-rate: 每秒收到的响应数</span><br><span class=\"line\">    </span><br><span class=\"line\">#### producer</span><br><span class=\"line\">waiting-threads: 缓存区排队的用户阻塞线程数</span><br><span class=\"line\">buffer-available-bytes: 可用内存字节数</span><br><span class=\"line\">batch-size-avg: 每个分区每次请求发送的平均字节数</span><br><span class=\"line\">compression-rate-avg: 批量记录平均压缩率</span><br><span class=\"line\">record-queue-time-avg: 批量记录耗费的平均时间（ms）</span><br><span class=\"line\">request-latency-avg: 平均请求时间（ms）</span><br><span class=\"line\">record-send-rate: 每秒发送的平均次数</span><br><span class=\"line\">record-retry-rate: 每秒重试发送次数</span><br><span class=\"line\">record-error-rate: 每秒错误数量次数</span><br><span class=\"line\">requests-in-flight: 目前等待响应的请求数量</span><br><span class=\"line\">metadata-age: 当前生产者数据使用周期（s）</span><br><span class=\"line\">    </span><br><span class=\"line\">#### consumer</span><br><span class=\"line\">##### Consumer Group</span><br><span class=\"line\">commit-latency-avg: 提交请求所用的平均时间</span><br><span class=\"line\">commit-rate: 每秒提交调用次数</span><br><span class=\"line\">assigned-partitions: 当前分配给该消费者的分区数（可选）</span><br><span class=\"line\">heartbeat-rate: 平均每秒心跳数</span><br><span class=\"line\">join-time-avg: 群组重新加入的平均时间</span><br><span class=\"line\">join-rate: 每秒连接组的数量</span><br><span class=\"line\">sync-time-avg: 群组同步所需的平均时间</span><br><span class=\"line\">sync-rate: 每秒同步的组数</span><br><span class=\"line\">    </span><br><span class=\"line\">##### consumer fetch</span><br><span class=\"line\">fetch-size-avg: 每次请求获取的平均字节数</span><br><span class=\"line\">bytes-consumed-rate: 每秒消耗的平均字节数</span><br><span class=\"line\">fetch-latency-avg: 请求所用的平均时间</span><br><span class=\"line\">fetch-rate: 每秒提取请求数</span><br><span class=\"line\">records-lag-max: 分区中记录的最大滞后数量</span><br><span class=\"line\">    </span><br><span class=\"line\">##### topic-level fetch</span><br><span class=\"line\">fetch-size-avg: topic请求的平均字节数</span><br><span class=\"line\">bytes-consumed-rate: topic每秒平均消耗的字节数</span><br><span class=\"line\"></span><br><span class=\"line\">#### streams</span><br><span class=\"line\">##### Thread</span><br><span class=\"line\">[commit|poll|process|punctuate]-latency-avg: 平均执行时间（ms）</span><br><span class=\"line\">[commit|poll|process|punctuate]-rate: 平均每秒请求数</span><br><span class=\"line\">task-created-rate: 每秒新建任务数</span><br><span class=\"line\">task-closed-rate: 每秒关闭任务数</span><br><span class=\"line\">skipped-records-rate: 每秒跳过记录数</span><br><span class=\"line\">    </span><br><span class=\"line\">##### Task</span><br><span class=\"line\">commit-latency-avg: 平均执行时间（ms）</span><br><span class=\"line\">commit-rate: 每秒提交的平均次数</span><br><span class=\"line\"></span><br><span class=\"line\">##### Processor Node</span><br><span class=\"line\">forward-rate: 每秒从源节点向下游转发的平均速率</span><br><span class=\"line\"></span><br><span class=\"line\">##### State Store </span><br><span class=\"line\">[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-latency-avg: 平均执行时间（ns）</span><br><span class=\"line\">[put|put-if-absent|get|delete|put-all|all|range|flush|restore]-rate: 每秒的平均运行速度</span><br><span class=\"line\"></span><br><span class=\"line\">#### others</span><br><span class=\"line\">GC、CPU、IO等</span><br><span class=\"line\"></span><br><span class=\"line\">### Monitoring实现</span><br><span class=\"line\">#### 方式一：</span><br><span class=\"line\">1.提供Web服务支持，执行监听器注册我们需要监控的指标，可按Json格式输出</span><br><span class=\"line\">2.启动后台进程定期通过Http请求抓取指标，并上报数据到redis队列</span><br><span class=\"line\">3.storm消费数据进行分析计算</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>需多依赖<br><dependency><br>    <groupId>io.dropwizard.metrics</groupId><br>    <artifactId>metrics-servlets</artifactId><br>    <version>3.1.0</version><br></dependency></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">#### 方式二：</span><br><span class=\"line\">1.重写KafkaReporter继承ScheduledReporter，构造相应指标，格式化、序列化Json，通过metrics收集统计结果</span><br><span class=\"line\">2.创建kafkaProducer将构造的结果数据按不同Topic分类发送给kafka</span><br><span class=\"line\">3.storm消费对应kafka数据，再进行分析计算</span><br><span class=\"line\"></span><br><span class=\"line\">Pom依赖：</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<dependency>\n    <groupId>org.apache.kafka</groupId>\n    <artifactId>kafka_2.11</artifactId>\n    <version>0.10.2.1</version>\n    <exclusions>\n        <exclusion>\n            <groupId>org.apache.zookeeper</groupId>\n            <artifactId>zookeeper</artifactId>\n            </exclusion>\n    </exclusions>\n</dependency>\n<dependency>\n    <groupId>org.apache.zookeeper</groupId>\n    <artifactId>zookeeper</artifactId>\n    <version>3.4.10</version>\n    <exclusions>\n        <exclusion>\n            <groupId>com.sun.jmx</groupId>\n            <artifactId>jmxri</artifactId>\n        </exclusion>\n            <exclusion>\n                <groupId>com.sun.jdmk</groupId>\n                <artifactId>jmxtools</artifactId>\n            </exclusion>\n            <exclusion>\n                <groupId>javax.jms</groupId>\n                <artifactId>jms</artifactId>\n            </exclusion>\n        </exclusions>\n    </dependency>\n    <dependency>\n           <groupId>io.dropwizard.metrics</groupId>\n           <artifactId>metrics-core</artifactId>\n           <version>3.1.0</version>\n    </dependency>\n```\n\n<h3 id=\"Kafka监控工具\"><a href=\"#Kafka监控工具\" class=\"headerlink\" title=\"Kafka监控工具\"></a>Kafka监控工具</h3><h4 id=\"KafkaOffsetMonitor\"><a href=\"#KafkaOffsetMonitor\" class=\"headerlink\" title=\"KafkaOffsetMonitor\"></a>KafkaOffsetMonitor</h4><blockquote>\n<p>是由Kafka开源社区提供的一款Web管理界面，配置操作简单，界面简单，但不能自动刷新，但功能覆盖不全<br>可以对consumer消费情况进行监控，并能列出每个consumer的offset数据<br>可以查看每个topic的partition的列表（topic，pid，offset，logsize，lag，owner等）<br>可以查看每个consumser group列表信息<br>可以查看topic的历史消费信息<br><a href=\"https://github.com/quantifind/KafkaOffsetMonitor\">源码地址</a></p>\n</blockquote>\n<h4 id=\"kafka-web-console\"><a href=\"#kafka-web-console\" class=\"headerlink\" title=\"kafka-web-console\"></a>kafka-web-console</h4><blockquote>\n<p>也是kafka开源的web监控程序，Scala编写，编译搭建相对于前者更复杂，默认用的数据库是H2，但可自动刷新。<br>可以查看brokers kafka集群信息<br>可以查看每个topic的Partition，logsize，分区leader等信息<br>可以查看consumer group的partition，offset，lag，owner等信息；topic feed最新发布消息<br>可以查看consumer偏移和滞后情况，历史消息以及consumer/producer消息吞吐量历史的图表<br>控制台还提供了RAML中描述的JSON API<br><a href=\"https://github.com/claudemamo/kafka-web-console\">源码地址</a></p>\n</blockquote>\n<h4 id=\"kafka-manger\"><a href=\"#kafka-manger\" class=\"headerlink\" title=\"kafka-manger\"></a>kafka-manger</h4><blockquote>\n<p>是由yahoo构建一款基于web的kafka管理器，可以管理多个kafka集群，且容易检测集群（topics,brokers,备份,分区）分布不均的情况<br>可以选择你要运行的副本<br>可以基于当前分区状况重新分配生成分区<br>可以选择topic配置并创建topic(0.8.1.1和0.8.2+的配置不同)<br>可以删除topic(只支持0.8.2+的版本并且要在broker配置中设置delete.topic.enable=true)，Topic list会指明哪些topic被删除<br>可以为已存在的topic增加分区，更新配置<br>可以支持多个topic批量重分区，选择partition broker位置等<br>可以启用JMX轮询代理，以及broker、metrics主题等级<br>可选地筛选出zookeeper中没有ids/owner/＆offset/目录的消费者<br><a href=\"https://github.com/yahoo/kafka-manager\">源码地址</a></p>\n</blockquote>\n<h2 id=\"QA\"><a href=\"#QA\" class=\"headerlink\" title=\"QA\"></a>QA</h2><p><strong>欢迎大家共同讨论、分享</strong></p>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"ckiev8tmo0001lgjk1ajb450b","category_id":"ckiev8tn30002lgjkcchedllg","_id":"ckiev8tn60005lgjk6dvacf55"}],"PostTag":[{"post_id":"ckiev8tmo0001lgjk1ajb450b","tag_id":"ckiev8tn40003lgjk9b55hddg","_id":"ckiev8tn60004lgjk0idkd24o"}],"Tag":[{"name":"大数据 kafka","_id":"ckiev8tn40003lgjk9b55hddg"}]}}